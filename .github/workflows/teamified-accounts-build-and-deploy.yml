# Docs for Azure Container Apps: https://docs.microsoft.com/azure/container-apps/
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: "[Prod] Build & Deploy - Teamified Accounts (Azure Container Apps)"

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Azure Configuration
  AZURE_SUBSCRIPTION: 'dfb37851-3ee5-4299-ade5-3c73a50506e0'
  # Taken from here: https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Overview/appId/17e8db29-5b12-42ea-b7ec-8cc2c7cb2450/isMSAApp~/false
  AZURE_CLIENT_ID: '17e8db29-5b12-42ea-b7ec-8cc2c7cb2450'
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  AZURE_TENANT_ID: '96cdd530-9baa-46bc-ad82-acd57b506df2'
  # Container App Configuration
  CONTAINER_APP_NAME: 'teamified-accounts'
  CONTAINER_REGISTRY: 'tmfregistryprod.azurecr.io'
  RESOURCE_GROUP: 'rg-tmf-prd-ausest'
  IMAGE_NAME: 'teamified-accounts'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CONTAINER_REGISTRY }}
          username: ${{ env.AZURE_CLIENT_ID }}
          password: ${{ env.AZURE_CLIENT_SECRET }}

      - name: Generate date tag for backup
        id: date
        run: echo "date_tag=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Backup current production image
        run: |
          docker pull ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest || echo "No existing latest image to backup"
          
          if docker image inspect ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest > /dev/null 2>&1; then
            docker tag ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:backup-${{ steps.date.outputs.date_tag }}
            docker push ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:backup-${{ steps.date.outputs.date_tag }}
            echo "Backed up current image to: backup-${{ steps.date.outputs.date_tag }}"
          else
            echo "No existing image found to backup"
          fi

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.unified
          push: true
          tags: |
            ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          build-args: |
            VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId": "${{ env.AZURE_CLIENT_ID }}", "clientSecret": "${{ env.AZURE_CLIENT_SECRET }}", "subscriptionId": "${{ env.AZURE_SUBSCRIPTION }}", "tenantId": "${{ env.AZURE_TENANT_ID }}"}'
      
      - name: Login to Azure Container Registry
        run: |
          az acr login --name tmfregistryprod
      
      - name: Deploy to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --subscription ${{ env.AZURE_SUBSCRIPTION }}
