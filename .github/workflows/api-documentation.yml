name: API Documentation Generation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.controller.ts'
      - 'src/**/*.dto.ts'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.controller.ts'
      - 'src/**/*.dto.ts'

jobs:
  generate-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Generate Swagger documentation
      run: |
        # Start the application in background
        npm run start:prod &
        APP_PID=$!
        
        # Wait for application to start
        sleep 30
        
        # Generate Swagger JSON
        curl -f http://localhost:3000/api/docs-json > swagger-docs.json
        
        # Kill the application
        kill $APP_PID
        
    - name: Validate Swagger JSON
      run: |
        # Validate JSON syntax
        python3 -m json.tool swagger-docs.json > /dev/null
        
        # Check for required fields
        python3 -c "
        import json
        with open('swagger-docs.json', 'r') as f:
            doc = json.load(f)
        
        required_fields = ['openapi', 'info', 'paths']
        for field in required_fields:
            if field not in doc:
                print(f'Missing required field: {field}')
                exit(1)
        
        # Check for documented endpoints
        paths = doc.get('paths', {})
        if not paths:
            print('No API endpoints documented')
            exit(1)
            
        print(f'Documented {len(paths)} API endpoints')
        "
        
    - name: Upload documentation artifact
      uses: actions/upload-artifact@v4
      with:
        name: swagger-documentation
        path: swagger-docs.json
        retention-days: 30
        
    - name: Comment PR with documentation status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const swaggerDoc = JSON.parse(fs.readFileSync('swagger-docs.json', 'utf8'));
          const paths = Object.keys(swaggerDoc.paths || {});
          
          const comment = `## ðŸ“š API Documentation Status
          
          **Generated Documentation:**
          - **Endpoints Documented:** ${paths.length}
          - **OpenAPI Version:** ${swaggerDoc.openapi || 'Unknown'}
          - **API Version:** ${swaggerDoc.info?.version || 'Unknown'}
          
          **Documented Endpoints:**
          ${paths.map(path => `- \`${path}\``).join('\n')}
          
          **Documentation Quality:**
          - âœ… Swagger JSON generated successfully
          - âœ… All endpoints documented
          - âœ… Documentation validation passed
          
          **Next Steps:**
          - Review the generated documentation
          - Ensure all new endpoints are properly documented
          - Verify error responses are comprehensive
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  validate-documentation:
    runs-on: ubuntu-latest
    needs: generate-documentation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download documentation artifact
      uses: actions/download-artifact@v4
      with:
        name: swagger-documentation
        path: .
        
    - name: Validate documentation completeness
      run: |
        python3 -c "
        import json
        import os
        
        with open('swagger-docs.json', 'r') as f:
            doc = json.load(f)
        
        paths = doc.get('paths', {})
        
        # Check for required controller endpoints
        required_endpoints = [
            '/api/health',
            '/api/health/detailed',
            '/api/v1/auth/login',
            '/api/v1/auth/logout',
            '/api/v1/users/me',
            '/api/v1/invitations'
        ]
        
        missing_endpoints = []
        for endpoint in required_endpoints:
            if endpoint not in paths:
                missing_endpoints.append(endpoint)
        
        if missing_endpoints:
            print('Missing required endpoints:')
            for endpoint in missing_endpoints:
                print(f'  - {endpoint}')
            exit(1)
        
        # Check for proper documentation structure
        for path, methods in paths.items():
            for method, details in methods.items():
                if method.upper() in ['GET', 'POST', 'PUT', 'PATCH', 'DELETE']:
                    if 'summary' not in details:
                        print(f'Missing summary for {method.upper()} {path}')
                        exit(1)
                    if 'responses' not in details:
                        print(f'Missing responses for {method.upper()} {path}')
                        exit(1)
        
        print('âœ… Documentation validation passed')
        "
        
    - name: Generate documentation report
      run: |
        python3 -c "
        import json
        
        with open('swagger-docs.json', 'r') as f:
            doc = json.load(f)
        
        paths = doc.get('paths', {})
        
        # Count endpoints by method
        methods = {}
        for path, path_methods in paths.items():
            for method in path_methods.keys():
                if method.upper() in ['GET', 'POST', 'PUT', 'PATCH', 'DELETE']:
                    methods[method.upper()] = methods.get(method.upper(), 0) + 1
        
        # Generate report
        report = f'''# API Documentation Report
        
        ## Summary
        - **Total Endpoints:** {len(paths)}
        - **API Version:** {doc.get('info', {}).get('version', 'Unknown')}
        - **OpenAPI Version:** {doc.get('openapi', 'Unknown')}
        
        ## Endpoints by Method
        '''
        
        for method, count in sorted(methods.items()):
            report += f'- **{method}:** {count}\n'
        
        report += '''
        ## Documentation Quality
        - âœ… All endpoints have summaries
        - âœ… All endpoints have response documentation
        - âœ… Required endpoints are present
        - âœ… Documentation structure is valid
        
        ## Next Steps
        1. Review the generated Swagger UI
        2. Test all documented endpoints
        3. Verify error responses are comprehensive
        4. Update examples if needed
        '''
        
        with open('documentation-report.md', 'w') as f:
            f.write(report)
        
        print('Documentation report generated')
        "
        
    - name: Upload documentation report
      uses: actions/upload-artifact@v4
      with:
        name: documentation-report
        path: documentation-report.md
        retention-days: 30
