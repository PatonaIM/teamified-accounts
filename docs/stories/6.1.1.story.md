# Story 6.1.1 — Shared Profile Components with Country-Specific Government IDs

## Status
Ready for Development

## Context from Story 6.1 & 6.2
Story 6.1 successfully implemented the onboarding wizard with Profile & Contact step:
- Route `/onboarding` with Material-UI Stepper
- Step persistence via localStorage scoped by employmentRecordId
- Profile form with basic fields (name, DOB, contact, address, emergency contact)
- Auto-save with 1-second debounce
- Audit logging with employmentRecordId/clientId context
- Design patterns: Material-UI 3 matching Profile page styling

Story 6.2 completed My Documents tabbed hub with category-based management.

**Story 6.1.1 refactors and enhances** to create reusable profile components shared between:
1. Profile page (`/profile`) - full profile management with all tabs
2. Onboarding wizard Step 1 - Profile & Contact section within onboarding flow

## Story
**As a** developer and user,
**I want** profile form components to be shared between the Profile page and Onboarding wizard,
**so that** we have consistent UX, maintainable code, and country-specific Government ID fields that only appear when users have employment records.

## Acceptance Criteria
1. **Component Extraction:** Profile form tabs extracted into reusable shared components
2. **ProfileTabsManager:** Configurable component that orchestrates which tabs to display
3. **Country-Specific IDs:** Government IDs tab only visible when user has employment record(s)
4. **Dynamic Fields:** Government ID fields shown based on employment record country (India, Philippines, Sri Lanka, Australia, etc.)
5. **Multiple Countries:** If user has employment in multiple countries, show combined relevant ID fields
6. **Country Validation:** Each country's ID fields have appropriate validation rules (PAN format, Aadhaar format, SSS format, etc.)
7. **Documents Tab Removed:** Documents tab removed from Profile page (handled separately in My Documents page)
8. **Onboarding Integration:** Onboarding Step 1 uses ProfileTabsManager with appropriate tab selection
9. **Profile Page Integration:** Profile page uses ProfileTabsManager with all tabs except Documents
10. **Design Consistency:** All components maintain Material-UI 3 expressive design patterns
11. **Accessibility:** WCAG 2.1 AA compliance; keyboard navigation; screen-reader friendly
12. **No Duplication:** Single source of truth for profile fields; changes update both Profile and Onboarding

## Country-Specific ID Fields

### India (IN)
- PAN Number (required, format: ABCDE1234F)
- Aadhaar Number (required, format: 12 digits)
- PF Number
- UAN
- TIN

### Philippines (PH)
- SSS Number (required, format: XX-XXXXXXX-X)
- PhilHealth Number (required, format: XX-XXXXXXXXX-X)
- Pag-IBIG Number (required, format: XXXX-XXXX-XXXX)
- TIN (required, format: XXX-XXX-XXX-XXX)

### Sri Lanka (LK)
- NIC Number (required, format: 9 digits + V or 12 digits)
- TIN

### Australia (AU)
- Tax File Number - TFN (format: 9 digits)
- Australian Business Number - ABN

### Default (any other country)
- National ID (required)
- Tax Identification Number

## Tasks / Subtasks

- [ ] Task 1: Configuration & Field Definitions (AC: 4, 5, 6)
  - [ ] Create `countryFieldsConfig.ts` with country-to-fields mapping
  - [ ] Define validation rules per country (regex patterns, required fields)
  - [ ] Add TypeScript interfaces for field definitions
  - [ ] Document field requirements and formats

- [ ] Task 2: Employment Countries Hook (AC: 3, 5)
  - [ ] Create `useEmploymentCountries` hook
  - [ ] Fetch user's employment records via existing API
  - [ ] Extract unique countries from active/onboarding employment records
  - [ ] Handle loading states and errors
  - [ ] Include country code, name, and employment status

- [ ] Task 3: Extract Shared Components (AC: 1, 10)
  - [ ] Create `frontend/src/components/profile/` directory structure
  - [ ] Extract `CoreInformationTab.tsx` from ProfilePage
  - [ ] Extract `PersonalDetailsTab.tsx` from ProfilePage
  - [ ] Extract `AddressTab.tsx` from ProfilePage
  - [ ] Extract `EmergencyContactsTab.tsx` from ProfilePage
  - [ ] Extract `BankingTab.tsx` from ProfilePage
  - [ ] Extract `PreferencesTab.tsx` from ProfilePage
  - [ ] Extract `StyledComponents.tsx` with Material-UI 3 styles
  - [ ] Create shared TypeScript types

- [ ] Task 4: Dynamic Government IDs Tab (AC: 3, 4, 5, 6)
  - [ ] Create `GovernmentIDsTab.tsx` component
  - [ ] Implement country-specific field rendering
  - [ ] Show informative message when no employment exists
  - [ ] Display chips/badges for countries requiring IDs
  - [ ] Merge fields from multiple countries (remove duplicates)
  - [ ] Apply country-specific validation rules
  - [ ] Show validation errors with helpful messages

- [ ] Task 5: ProfileTabsManager Component (AC: 2, 7, 8, 9)
  - [ ] Create `ProfileTabsManager.tsx` orchestrator component
  - [ ] Implement tab configuration (include/exclude tabs)
  - [ ] Handle conditional tab visibility (Government IDs based on employment)
  - [ ] Pass country data to Government IDs tab
  - [ ] Support both full mode (Profile page) and onboarding mode
  - [ ] Maintain step persistence for onboarding
  - [ ] Preserve existing save/auto-save functionality

- [ ] Task 6: Update Profile Page (AC: 7, 9, 10)
  - [ ] Replace inline tabs with ProfileTabsManager
  - [ ] Configure to exclude Documents tab
  - [ ] Maintain existing employment/salary history sections
  - [ ] Verify all fields work correctly
  - [ ] Test country-specific Government IDs visibility
  - [ ] Ensure save functionality works

- [ ] Task 7: Update Onboarding Step 1 (AC: 8, 10)
  - [ ] Update OnboardingStepProfileContact to use ProfileTabsManager
  - [ ] Configure tabs: Core, Personal, Address, Government IDs (if employment), Emergency, Banking
  - [ ] Wire up onboarding-specific save handlers
  - [ ] Maintain auto-save and step completion logic
  - [ ] Test with different employment countries
  - [ ] Verify field visibility based on employment record country

- [ ] Task 8: Backend Enhancement (AC: 4)
  - [ ] Verify employment records API returns country information
  - [ ] Ensure country object includes id, code, and name
  - [ ] Add country validation if needed
  - [ ] Update API documentation

- [ ] Task 9: Testing & QA (AC: 1–12)
  - [ ] Unit tests for countryFieldsConfig
  - [ ] Unit tests for useEmploymentCountries hook
  - [ ] Unit tests for GovernmentIDsTab rendering logic
  - [ ] Integration tests for ProfileTabsManager
  - [ ] Test country-specific field visibility
  - [ ] Test multi-country scenarios
  - [ ] Test validation rules per country
  - [ ] E2E tests for Profile page with shared components
  - [ ] E2E tests for Onboarding with shared components
  - [ ] Accessibility tests (keyboard navigation, screen readers)

- [ ] Task 10: Documentation (AC: 1–12)
  - [ ] Document component architecture
  - [ ] Add usage examples for ProfileTabsManager
  - [ ] Document country field configuration
  - [ ] Update developer guide for adding new countries
  - [ ] Add troubleshooting section

## Technical Requirements

### Component Architecture
```
frontend/src/components/profile/
├── ProfileTabsManager.tsx              # Main orchestrator
├── config/
│   ├── countryFieldsConfig.ts          # Country → fields mapping
│   └── fieldValidation.ts              # Validation rules
├── hooks/
│   ├── useEmploymentCountries.ts       # Fetch employment countries
│   └── useProfileData.ts               # Profile data management
├── tabs/
│   ├── CoreInformationTab.tsx          # Name, email, DOB
│   ├── PersonalDetailsTab.tsx          # Gender, marital status
│   ├── AddressTab.tsx                  # Residential address
│   ├── GovernmentIDsTab.tsx            # Dynamic, country-aware
│   ├── EmergencyContactsTab.tsx        # Emergency contacts
│   ├── BankingTab.tsx                  # Bank details
│   └── PreferencesTab.tsx              # Language, notifications
└── shared/
    ├── StyledComponents.tsx            # Material-UI 3 components
    └── types.ts                        # TypeScript interfaces
```

### Database Schema (No Changes Required)
- Uses existing `employment_records` table with `country_id` FK
- Uses existing `countries` table with `code` and `name` fields
- Uses existing `users.profile_data` JSONB column for Government IDs
- Optional: Use `region_configurations` table for admin-managed field configs

### API Requirements
- Employment records API must return country information:
  ```typescript
  {
    id: UUID,
    userId: UUID,
    countryId: UUID,
    country: {
      id: UUID,
      code: string,    // 'IN', 'PH', 'LK', 'AU', etc.
      name: string     // 'India', 'Philippines', etc.
    },
    status: string
  }
  ```

### Tab Configuration Examples
```typescript
// Profile Page
<ProfileTabsManager
  userId={user.id}
  excludeTabs={['documents']}
  mode="full"
/>

// Onboarding Step 1
<ProfileTabsManager
  userId={user.id}
  employmentRecordId={employmentRecordId}
  includeTabs={['core', 'personal', 'address', 'governmentIds', 'emergency', 'banking']}
  mode="onboarding"
  onSave={handleOnboardingSave}
  onComplete={onComplete}
/>
```

## Testing Strategy
- Unit: Country field configuration, validation rules, field mapping
- Unit: Employment countries hook with mocked API responses
- Integration: ProfileTabsManager with different configurations
- Integration: Country-specific field visibility based on employment
- E2E: Profile page with Government IDs for Indian employment
- E2E: Onboarding with Government IDs for Philippines employment
- E2E: User with multiple countries (India + Philippines)
- E2E: User with no employment (no Government IDs tab)
- Performance: p95 Government IDs field render < 200ms
- Accessibility: Keyboard navigation, screen reader announcements

## UI/UX Requirements
- Material-UI 3 expressive design system (matching existing patterns)
- Government IDs tab only appears when user has employment
- Clear messaging when no employment exists
- Country badges/chips showing which countries require IDs
- Inline validation with country-specific error messages
- Consistent styling with Profile page and Onboarding wizard
- Responsive layout for mobile, tablet, desktop
- Loading states while fetching employment countries
- Graceful error handling if country data unavailable

## Dependencies
- **Story 6.1** (COMPLETED): Onboarding wizard shell and Profile & Contact step
- **Story 6.2** (COMPLETED): My Documents (provides reference for Documents tab removal)
- Epic 6: EOR Onboarding Workflow
- Existing Profile page (`/profile`)
- Employment Records API with country information
- Countries reference data in database

## Risks & Mitigation
- Breaking existing Profile page → Incremental refactor; comprehensive testing
- Country field config maintenance → Document clearly; make config-driven
- Missing country data → Fallback to DEFAULT fields; graceful degradation
- Multiple employment countries complexity → Clear UX for combined fields
- Validation rule conflicts → Per-country rules; clear error messages

## Definition of Done
- All ACs satisfied; tasks completed; tests pass
- Profile page uses ProfileTabsManager successfully
- Onboarding Step 1 uses ProfileTabsManager successfully
- Government IDs tab shows only with employment
- Country-specific fields display correctly for IN, PH, LK, AU
- Validation rules work for each country's ID formats
- Documents tab removed from Profile page
- No code duplication between Profile and Onboarding
- Accessibility checks pass (WCAG 2.1 AA)
- Documentation updated with architecture and usage
- Developer guide includes instructions for adding new countries

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5 (via Cursor/Claude Code)

### Implementation Summary
(To be completed during implementation)

### Key Decisions
(To be documented during implementation)

### Completion Notes
(To be added upon completion)

### File List
(To be populated during implementation)

**Frontend - Expected New Files:**
- `frontend/src/components/profile/ProfileTabsManager.tsx`
- `frontend/src/components/profile/config/countryFieldsConfig.ts`
- `frontend/src/components/profile/config/fieldValidation.ts`
- `frontend/src/components/profile/hooks/useEmploymentCountries.ts`
- `frontend/src/components/profile/hooks/useProfileData.ts`
- `frontend/src/components/profile/tabs/CoreInformationTab.tsx`
- `frontend/src/components/profile/tabs/PersonalDetailsTab.tsx`
- `frontend/src/components/profile/tabs/AddressTab.tsx`
- `frontend/src/components/profile/tabs/GovernmentIDsTab.tsx`
- `frontend/src/components/profile/tabs/EmergencyContactsTab.tsx`
- `frontend/src/components/profile/tabs/BankingTab.tsx`
- `frontend/src/components/profile/tabs/PreferencesTab.tsx`
- `frontend/src/components/profile/shared/StyledComponents.tsx`
- `frontend/src/components/profile/shared/types.ts`
- `frontend/src/components/profile/__tests__/useEmploymentCountries.test.ts`
- `frontend/src/components/profile/__tests__/GovernmentIDsTab.test.tsx`

**Frontend - Expected Modified Files:**
- `frontend/src/pages/ProfilePage.tsx` (refactored to use ProfileTabsManager)
- `frontend/src/components/onboarding/OnboardingStepProfileContact.tsx` (refactored to use ProfileTabsManager)

**Backend - Expected Modified Files:**
- `src/employment-records/controllers/employment-records.controller.ts` (ensure country included in response)
- `src/employment-records/services/employment-records.service.ts` (join country relation)

**Documentation - Expected New Files:**
- `docs/architecture/shared-profile-components.md`
- `docs/guides/adding-new-countries.md`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation for shared profile components with country-specific Government IDs | Dev Agent Claude |
