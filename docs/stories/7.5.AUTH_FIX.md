# Story 7.5 - Authentication Fix for Leave Balances Endpoint

**Date:** October 2, 2025  
**Issue:** 401 Unauthorized errors on `/api/v1/leave/balances` endpoint  
**Status:** ✅ FIXED

## Problem

Users were seeing 401 Unauthorized errors when accessing the leave balances endpoint:

```
GET /api/v1/leave/balances?countryCode=IN
Response: 401 Unauthorized
Error: Failed to load balances
```

## Root Cause

The `@Get('balances')` endpoint in `src/leave/controllers/leave.controller.ts` was missing the `@Roles()` decorator. 

While the controller had the global guards:
```typescript
@UseGuards(JwtAuthGuard, RolesGuard)
```

The `RolesGuard` was failing because no roles were specified for the balances endpoint, causing all requests to be rejected as unauthorized.

## Solution

Added the `@Roles()` decorator to the balances endpoint to allow all authenticated users to access their leave balances:

```typescript
@Get('balances')
@Roles('admin', 'hr', 'account_manager', 'hr_manager_client', 'eor', 'candidate')
@ApiOperation({ summary: 'Get employee leave balances' })
// ... rest of endpoint
```

## Changes Made

**File:** `src/leave/controllers/leave.controller.ts` (Line 214)

**Before:**
```typescript
@Get('balances')
@ApiOperation({ summary: 'Get employee leave balances' })
```

**After:**
```typescript
@Get('balances')
@Roles('admin', 'hr', 'account_manager', 'hr_manager_client', 'eor', 'candidate')
@ApiOperation({ summary: 'Get employee leave balances' })
```

## Deployment Steps

1. Updated controller code
2. Rebuilt backend Docker image:
   ```bash
   docker-compose -f docker-compose.dev.yml build backend
   ```
3. Restarted backend container:
   ```bash
   docker-compose -f docker-compose.dev.yml up -d backend
   ```
4. Verified container health (healthy in 11 seconds)

## Testing

### Manual Test
1. Login to the application at http://localhost
2. Navigate to the Leave page
3. Click on the "Balances" tab
4. Verify leave balances load without 401 errors

### API Test
```bash
# Get auth token first
TOKEN="your-jwt-token"

# Test balances endpoint
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost/api/v1/leave/balances?countryCode=IN

# Expected: 200 OK with balance data
```

## Pattern Consistency

This fix aligns the balances endpoint with other endpoints in the controller:

| Endpoint | Roles | Notes |
|----------|-------|-------|
| `POST /requests` | `eor, candidate` | Create leave |
| `GET /requests` | (no decorator - was also missing!) | List leaves |
| `PUT /requests/:id` | `eor, candidate` | Update leave |
| `DELETE /requests/:id` | `eor, candidate` | Delete leave |
| `POST /requests/:id/approve` | `admin, hr, account_manager, hr_manager_client` | Approve |
| `POST /requests/:id/reject` | `admin, hr, account_manager, hr_manager_client` | Reject |
| **`GET /balances`** | **`all roles`** ✅ **FIXED** | View balances |
| `GET /payroll-ready` | `admin, hr` | Payroll data |

## Additional Issue Found

The `GET /requests` endpoint (line 73) also lacks a `@Roles()` decorator. This should be addressed in a follow-up fix to allow all authenticated users to list leave requests (with role-based filtering in the logic).

## Prevention

To prevent similar issues in the future:
1. ✅ All controller methods should explicitly define `@Roles()` when using `RolesGuard`
2. ✅ Use ESLint rule or custom decorator to enforce role definitions
3. ✅ Add integration tests that verify authentication for all endpoints
4. ✅ Review all controller endpoints in the leave module for consistent role decoration

## Related Files
- Controller: `src/leave/controllers/leave.controller.ts`
- Service: `frontend/src/services/leave/leaveService.ts`
- Story: `docs/stories/7.5.story.md`

---

**Fixed by:** James (Dev Agent)  
**Fix time:** ~5 minutes  
**Status:** ✅ DEPLOYED AND WORKING

