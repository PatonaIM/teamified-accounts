# Story 2.1: Role-Based Access Control Migration

## Status
Done

## Story
**As a** system administrator,
**I want** to migrate from the current 5-role system to a comprehensive 7-role system with proper navigation restrictions and EOR-client access control,
**so that** users only see and access features appropriate to their role and organizational boundaries, while leveraging existing employment records for EOR-client relationships.

## Acceptance Criteria
1. **Database Schema Updates:** Add 2 new role types and update constraints
2. **Backend Role System Enhancement:** Update role permissions and EOR-client access control
3. **EOR-Client Access Control:** Implement access control using employment_records table
4. **Frontend Navigation Restrictions:** Role-based menu and page access control
5. **Role-Based Page Access Matrix:** Implement complete access control matrix
6. **Data Access Filtering:** Filter EOR data by active employment records
7. **User Role Migration:** Migrate existing users to new role structure
8. **Testing & Validation:** Comprehensive testing of all access controls

## Tasks / Subtasks
- [x] Task 1: Database Schema Migration (AC: 1)
  - [x] Add new role types: `account_manager` and `recruiter`
  - [x] Update role constraints to support all 7 role types
  - [x] Create migration script with rollback capability
  - [x] Preserve all existing user role assignments
- [x] Task 2: Backend Role Service Updates (AC: 2, 3)
  - [x] Update UserRole entity to support new role types
  - [x] Update role permission matrix for all 7 roles
  - [x] Implement EOR-client access control using employment_records
  - [x] Add service methods for EOR access validation
  - [ ] Update all DTOs and validation for new roles
- [ ] Task 3: EOR-Client Access Control Implementation (AC: 3, 6)
  - [ ] Create service methods to get EOR assigned clients
  - [ ] Implement EOR data access filtering by employment records
  - [ ] Add validation for EOR-client data access
  - [ ] Update permission service with EOR access logic
- [x] Task 4: Frontend Navigation System (AC: 4, 5)
  - [x] Create role-based navigation component
  - [x] Update ProtectedRoute with role checking
  - [x] Implement role-based page access control
  - [x] Add unauthorized access handling
  - [x] Update all route definitions with role requirements
- [x] Task 5: User Role Migration (AC: 7)
  - [x] Create user role migration script
  - [x] Map existing users to appropriate new roles
  - [x] Create EOR employment records for client assignments
  - [x] Preserve existing permissions during migration
- [x] Task 6: Testing & Validation (AC: 8)
  - [x] Test all role-based access controls
  - [x] Validate navigation restrictions for each role
  - [x] Test EOR-client access control
  - [x] Verify data integrity throughout migration

## Technical Requirements

### Backend Implementation
- [ ] **Database Migration**: Update user_roles table constraints
- [ ] **Service Updates**: Enhance UserRolesService with EOR access methods
- [ ] **Permission Matrix**: Update role permissions for all 7 roles
- [ ] **EOR Access Control**: Implement employment record-based access
- [ ] **API Updates**: Update all role-related endpoints

### Frontend Implementation
- [ ] **Navigation Component**: Role-based menu filtering
- [ ] **Protected Routes**: Enhanced route protection with role checking
- [ ] **Access Control**: Implement page-level access restrictions
- [ ] **User Experience**: Smooth role-based interface adaptation

### Database Changes
- [ ] **Role Types**: Add `account_manager` and `recruiter` to role constraints
- [ ] **No New Tables**: Leverage existing employment_records table
- [ ] **Migration Script**: Safe migration with rollback capability
- [ ] **Data Integrity**: Preserve all existing user data

## Role Access Matrix

| Page | Admin | HR Manager (T) | Account Manager | Recruiter | HR Manager (C) | EOR | Candidate |
|------|-------|----------------|----------------|-----------|----------------|-----|-----------|
| **Dashboard** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Profile** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **User Management** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **Employment Records** | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ |
| **Salary History** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **Timesheets** | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ❌ |
| **Leave** | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ |
| **Documents** | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ |
| **CV Management** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ |
| **Invitations** | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |

## Implementation Details

### Database Migration
```sql
-- Add new role types
ALTER TABLE user_roles DROP CONSTRAINT IF EXISTS CHK_role_type;
ALTER TABLE user_roles ADD CONSTRAINT CHK_role_type CHECK (
  role_type IN ('candidate', 'eor', 'admin', 'hr', 'account_manager', 'recruiter', 'hr_manager_client')
);
```

### EOR-Client Access Service Methods
```typescript
// Get EOR's assigned clients from employment records
async getEORAssignedClients(eorUserId: string): Promise<string[]>

// Check if EOR can access specific client data
async canEORAccessClientData(eorUserId: string, clientId: string): Promise<boolean>

// Get EOR data access scope
async getEORDataAccess(userId: string, dataType: string): Promise<string[]>
```

### Role-Based Navigation Component
```typescript
// Navigation items filtered by user role
const getNavigationItems = (userRole: string) => {
  const baseItems = [
    { title: 'Dashboard', href: '/dashboard', roles: ['all'] },
    { title: 'Profile', href: '/profile', roles: ['all'] }
  ];
  
  const roleSpecificItems = {
    admin: [/* admin-specific items */],
    hr_manager_teamified: [/* HR manager items */],
    account_manager: [/* account manager items */],
    // ... other roles
  };
  
  return [...baseItems, ...(roleSpecificItems[userRole] || [])];
};
```

### Enhanced Protected Route
```typescript
// Route protection with role checking
<ProtectedRoute requiredRoles={['admin', 'hr_manager_teamified']}>
  <UserManagement />
</ProtectedRoute>
```

## Role Permission Matrix

### Admin (teamified)
- **Permissions**: Full system access, all data, system administration
- **Access**: All pages, all data, can manage all users and roles

### HR Manager (teamified)
- **Permissions**: All EOR employment data, all client data, user management
- **Access**: All pages except system admin, can manage EORs and clients

### Account Manager (teamified)
- **Permissions**: All client data, EOR timesheets, business data
- **Access**: Business-focused pages, can view all EOR timesheets

### Recruiter (teamified)
- **Permissions**: Candidate management, invitation management
- **Access**: Candidate and invitation pages only

### HR Manager (client)
- **Permissions**: Own client data only, EOR timesheets for their client
- **Access**: Client-scoped pages only, limited to their organization

### EOR (teamified)
- **Permissions**: Own data, assigned client data only
- **Access**: Personal pages + assigned client data, filtered by employment records

### Candidate
- **Permissions**: Own profile data only
- **Access**: Profile and CV management pages only

## Testing Requirements

### Backend Testing
- [ ] **Unit Tests**: Test all role service methods
- [ ] **Integration Tests**: Test EOR-client access control
- [ ] **Permission Tests**: Verify role-based data filtering
- [ ] **Migration Tests**: Test user role migration script

### Frontend Testing
- [ ] **Navigation Tests**: Test role-based menu filtering
- [ ] **Route Tests**: Test protected route access control
- [ ] **Component Tests**: Test role-based component visibility
- [ ] **Integration Tests**: Test complete user workflows per role

## Security Considerations

### Access Control
- [ ] **Role Validation**: Ensure all endpoints validate user roles
- [ ] **Data Filtering**: EOR data filtered by employment records
- [ ] **Navigation Security**: Frontend navigation respects backend permissions
- [ ] **Route Protection**: All sensitive routes properly protected

### Data Protection
- [ ] **EOR Data Isolation**: EORs cannot access other EORs' data
- [ ] **Client Data Boundaries**: Proper client data access restrictions
- [ ] **Audit Logging**: Log all role-based access attempts

## Performance Considerations

### Backend Performance
- [ ] **Efficient Queries**: Optimize employment record queries for EOR access
- [ ] **Caching**: Cache role permissions where appropriate
- [ ] **Database Indexes**: Ensure proper indexing for role-based queries

### Frontend Performance
- [ ] **Lazy Loading**: Load role-specific components on demand
- [ ] **Navigation Optimization**: Efficient role-based menu rendering
- [ ] **State Management**: Optimize role-based state updates

## Migration Strategy

### Phase 1: Database & Backend (2-3 days)
1. Create database migration script
2. Update UserRole entity and services
3. Implement EOR-client access methods
4. Update role permission matrix

### Phase 2: Frontend Navigation (2-3 days)
1. Create role-based navigation component
2. Update ProtectedRoute with role checking
3. Implement page-level access control
4. Add unauthorized access handling

### Phase 3: Migration & Testing (1-2 days)
1. Create user role migration script
2. Test all access controls
3. Validate navigation restrictions
4. Create rollback procedures

## Risk Mitigation

- **Data Integrity**: Migration script with validation and rollback
- **User Experience**: Gradual rollout with fallback to current behavior
- **Performance**: Efficient queries for role-based data filtering
- **Security**: Comprehensive testing of access controls

## Dependencies
- Employment records table (already exists)
- User roles table (already exists)
- Frontend navigation system (already exists)
- Authentication system (already exists)

## Definition of Done

### Backend
- [ ] All 7 roles supported in database and backend
- [ ] EOR-client access control working via employment records
- [ ] Role permission matrix updated and tested
- [ ] Migration script tested and validated
- [ ] All role-related APIs updated

### Frontend
- [ ] Navigation menu shows only relevant items per role
- [ ] All pages protected with appropriate role checks
- [ ] Role-based component visibility implemented
- [ ] Unauthorized access handling working
- [ ] User experience smooth across all roles

### General
- [ ] All tests passing
- [ ] Migration script tested with rollback
- [ ] Documentation updated
- [ ] Security review completed
- [ ] User acceptance testing completed

## Change Log
- **2024-12-19**: Initial story creation

---

**Story Type**: Feature  
**Priority**: High  
**Estimate**: 8 Story Points  
**Assignee**: TBD  
**Reviewer**: TBD  
**Status**: Ready for Development
