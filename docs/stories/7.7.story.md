# Story 7.7: Compliance Reporting & Tax Management

## Status
Ready for Development

## Story
**As a** HR manager and finance team,
**I want** automated compliance reporting and tax management for India and Philippines,
**so that** I can generate statutory reports, manage tax filings, and ensure compliance with local labor laws and tax regulations using the configured payroll system.

## Acceptance Criteria
1. **India Compliance Reports:** Generate PF, ESI, TDS, and PT reports using configuration from Story 7.2
2. **Philippines Compliance Reports:** Generate SSS, PhilHealth, Pag-IBIG, and BIR reports using configuration from Story 7.2
3. **Automated Report Generation:** Reports generated automatically based on payroll processing
4. **Report Scheduling:** Configurable report generation schedules
5. **Report Export:** Export reports in required formats (PDF, Excel, CSV)
6. **Tax Filing Integration:** Integration with tax filing systems and deadlines
7. **Compliance Dashboard:** Dashboard showing compliance status and upcoming deadlines
8. **Audit Trail:** Complete tracking of report generation and filing
9. **API Integration:** RESTful API endpoints following existing v1 patterns
10. **UI Integration:** Material-UI interface following existing design system

## Tasks / Subtasks
- [ ] Task 1: Create Compliance Reporting Module (AC: 1, 2, 9)
  - [ ] Create compliance reporting module with services and controllers
  - [ ] Create ComplianceReport entity for report generation and storage
  - [ ] Create ReportSchedule entity for automated report scheduling
  - [ ] Update init-db.sql with compliance reporting tables
  - [ ] Set up report generation service for multiple countries
  - [ ] **INTEGRATE:** Use PayslipStorageService from Story 7.6 as primary data source
  - [ ] **INTEGRATE:** Use ContributionTrackingService from Story 7.6 for YTD summaries
  - [ ] **INTEGRATE:** Use AuditService from Story 7.3 for report generation audit trail
  - [ ] Create compliance reporting controller with REST endpoints
  - [ ] Implement compliance reporting DTOs
  - [ ] Add role-based authorization using existing guards

- [ ] Task 2: Implement India Compliance Reports (AC: 1)
  - [ ] Create PF report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] Create ESI report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] Create TDS report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] Create PT report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] **DATA SOURCE:** Use PayslipStorageService to query payslips filtered by country (India) and period
  - [ ] **NO RE-CALCULATION:** Aggregate statutory deduction fields from existing payslip records
  - [ ] Integrate with multi-region foundation from Story 7.1 for country context
  - [ ] Add India-specific report validation and formatting

- [ ] Task 3: Implement Philippines Compliance Reports (AC: 2)
  - [ ] Create SSS report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] Create PhilHealth report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] Create Pag-IBIG report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] Create BIR report generation service aggregating data from stored Payslip records (Story 7.6)
  - [ ] **DATA SOURCE:** Use PayslipStorageService to query payslips filtered by country (Philippines) and period
  - [ ] **NO RE-CALCULATION:** Aggregate statutory deduction fields from existing payslip records
  - [ ] Integrate with multi-region foundation from Story 7.1 for country context
  - [ ] Add Philippines-specific report validation and formatting

- [ ] Task 4: Implement Report Automation (AC: 3, 4)
  - [ ] Create automated report generation service
  - [ ] Implement report scheduling and triggers
  - [ ] Add report generation status tracking
  - [ ] Create report generation error handling and retry
  - [ ] Add report generation notifications
  - [ ] **INTEGRATE:** Use AuditService from Story 7.3 for automated report generation audit trail

- [ ] Task 5: Implement Report Export and Management (AC: 5, 6, 8)
  - [ ] Create report export service (PDF, Excel, CSV)
  - [ ] Implement report storage and retrieval
  - [ ] Add report versioning and history
  - [ ] Create report audit trail and logging via AuditService (Story 7.3)
  - [ ] Add report security and access control
  - [ ] **IMPLEMENT:** Caching for frequently generated reports (5-minute TTL following Story 7.3 pattern)
  - [ ] **IMPLEMENT:** Automatic cache cleanup for expired report entries

- [ ] Task 6: Update Database Seed Script (AC: 1, 2, 3)
  - [ ] Update seed-database.js with sample compliance data
  - [ ] Add sample compliance reports for India and Philippines
  - [ ] Add sample report schedules and deadlines
  - [ ] Include realistic compliance scenarios for testing

- [ ] Task 7: Create Compliance Dashboard (AC: 7, 10)
  - [ ] Create CompliancePage.tsx using Material-UI with tab-based layout (follow Stories 7.4-7.6 patterns)
  - [ ] **Tab 1: Available Reports** - List view with DataGrid (filtering by type, status, date range, pagination)
  - [ ] **Tab 2: Generate Reports** - Admin/HR only, report generation interface with country and period selectors
  - [ ] **Tab 3: Scheduled Reports** - Admin/HR only, report scheduling management
  - [ ] **Tab 4: Compliance Status** - Dashboard showing compliance status and upcoming deadlines
  - [ ] Create ReportListView.tsx component (similar to PayslipListView from Story 7.6)
  - [ ] Create ReportPreviewDialog.tsx component (similar to PayslipPreviewDialog from Story 7.6)
  - [ ] Create ReportGenerationPanel.tsx component (similar to PayslipGenerationPanel from Story 7.6)
  - [ ] Add responsive design and accessibility compliance (WCAG 2.1 AA)
  - [ ] Implement error handling with Alert components and loading states with CircularProgress
  - [ ] Add success/error notifications using existing Snackbar pattern
  - [ ] **INTEGRATE:** Use performance monitoring for report generation times (Story 7.3 pattern)

## Dev Notes
### Previous Story Insights
This story builds on completed foundational stories and Stories 7.1-7.6:
- **Story 1.5:** Uses salary history system for salary data
- **Story 1.4:** Uses employment records for employee data
- **Story 1.2:** Uses user management for employee information
- **Story 2.1:** Uses role-based access control for compliance permissions
- **Story 2.5:** Uses Material-UI design system for consistent interface
- **Story 2.6:** Uses existing v1 API patterns and integration
- **Story 7.1:** Uses multi-region foundation for country context and currency support
- **Story 7.2:** Uses statutory components configuration for report generation
- **Story 7.3:** Uses AuditService for audit trail, caching patterns (5-min TTL), and performance monitoring
- **Story 7.4:** Follow timesheet management patterns for data integration and reconciliation
- **Story 7.5:** Follow leave management patterns for data integration and reconciliation
- **Story 7.6:** **CRITICAL** - Uses PayslipStorageService for report data source, ContributionTrackingService for YTD summaries, TaxDocumentService for tax document management

### Data Models
Compliance reporting uses existing entities and new payroll entities:
- **User Entity:** Employee information and profile data
- **Employment Records:** Current employment status and client relationships
- **Salary History:** Salary information for calculations
- **User Roles:** Access control for compliance reporting
- **Statutory Components:** From Story 7.2 for report generation
- **Salary Components:** From Story 7.2 for calculation validation
- **Payroll Periods:** From Story 7.1 for pay period information
- **Payslip Entity:** From Story 7.6 - **PRIMARY DATA SOURCE** for compliance reports (contains stored payroll calculation results)

### API Specifications
Compliance reporting endpoints to be created:
- **GET /api/v1/compliance/reports** - List compliance reports (Admin/HR roles)
- **POST /api/v1/compliance/reports/generate** - Generate compliance report (Admin/HR roles)
- **GET /api/v1/compliance/reports/:id** - Get report details (Admin/HR roles)
- **GET /api/v1/compliance/reports/:id/download** - Download report (Admin/HR roles)
- **GET /api/v1/compliance/status** - Get compliance status (Admin/HR roles)
- **GET /api/v1/compliance/deadlines** - Get upcoming deadlines (Admin/HR roles)

### Business Rules
- **Compliance Reporting Authorization:**
  - **Admin and HR roles:** Can access all compliance reporting features
  - **Other roles:** Cannot access compliance reporting (restricted to Admin/HR only)
- **Data Source Rules (CRITICAL):**
  - Compliance reports are generated from STORED Payslip records (via PayslipStorageService from Story 7.6)
  - DO NOT re-calculate payroll data for compliance reports
  - Reports aggregate statutory deductions from existing payslips by period
  - Use ContributionTrackingService from Story 7.6 for YTD contribution summaries
- Reports must be generated in the required format for each country
- Report generation is scheduled based on statutory requirements
- All report generation activities are audited and logged via AuditService (from Story 7.3)
- Reports are stored securely with proper access controls
- Report generation uses statutory components configured in Story 7.2
- Frequently accessed reports are cached with 5-minute TTL (Story 7.3 pattern)

## Dependencies
- **Story 7.1:** Multi-Region Foundation ✅ **COMPLETE** (provides CountryService, CurrencyService, PayrollPeriodService)
- **Story 7.2:** Salary & Statutory Components Configuration ✅ **COMPLETE** (provides StatutoryComponentService for report generation)
  - **IMPORTANT:** Includes country-specific component mapping (`frontend/src/config/countryComponentMapping.ts`)
  - Compliance reports must only generate for statutory components applicable to the selected country
  - Report UI should filter report types based on country-specific statutory components (e.g., EPF/ESI/PT/TDS reports for India only, SSS/PhilHealth/Pag-IBIG reports for Philippines only)
- **Story 7.3:** Payroll Calculation Engine ✅ **COMPLETE** (provides AuditService, caching patterns, performance monitoring)
- **Story 7.6:** Employee Payroll Self-Service ✅ **COMPLETE** - **CRITICAL DEPENDENCY**
  - **Primary Data Source:** PayslipStorageService provides stored payroll calculation results
  - **Contribution Summaries:** ContributionTrackingService provides YTD contribution data
  - **Tax Documents:** TaxDocumentService handles tax document management
  - **DO NOT duplicate data** - compliance reports should use existing stored payslip records
- **Story 1.2:** User Management (for employee information)
- **Story 1.4:** Employment Records Management (for employee data)
- **Story 1.5:** Salary History Management (for salary data)
- **Story 2.1:** Role-Based Access Control (for compliance permissions)

## Integration Points with Previous Stories

### Story 7.1 (Multi-Region Foundation)
- **Services:** CountryService, CurrencyService, PayrollPeriodService for country context and currency support
- **Entities:** Country, Currency, PayrollPeriod for country context and period information
- **API Patterns:** Follow existing country-scoped API patterns

### Story 7.2 (Salary & Statutory Components)
- **Services:** StatutoryComponentService for report generation and component validation
- **Entities:** StatutoryComponent for report data
- **Component Mapping:** Use country-specific component mapping for report type filtering

### Story 7.3 (Payroll Calculation Engine)
- **AuditService:** Integrate for compliance report generation audit trail
- **Caching Patterns:** Apply 5-minute in-memory TTL for frequently accessed reports
- **Performance Monitoring:** Leverage performance metrics patterns for report generation tracking

### Story 7.4 & 7.5 (Timesheet & Leave Management)
- **Data Integration:** Include approved timesheet and leave data in payroll reconciliation reports
- **Cross-Reference:** Link statutory calculations with timesheet overtime and leave impacts

### Story 7.6 (Employee Payroll Self-Service) - PRIMARY DATA SOURCE
- **PayslipStorageService:** Use stored Payslip records as primary data source for compliance reports
- **ContributionTrackingService:** Leverage existing YTD contribution summaries (no need to re-aggregate)
- **TaxDocumentService:** Integrate for tax document references in compliance reports
- **Data Source Rule:** Compliance reports aggregate statutory deductions from existing payslips by period
- **NO RE-CALCULATION:** Do not re-calculate payroll data - use stored results from Story 7.6

### File Locations

**Backend:**
- Compliance reporting service: `src/compliance/services/compliance-reporting.service.ts` (new)
- Compliance reporting controller: `src/compliance/controllers/compliance-reporting.controller.ts` (new)
- DTOs: `src/compliance/dto/` directory (new)
- Update module: `src/compliance/compliance.module.ts` (new)

**Frontend (following Stories 7.4-7.6 patterns):**
- Compliance page: `frontend/src/pages/CompliancePage.tsx` (new - 4-tab layout)
- Compliance components: `frontend/src/components/compliance/` (new)
  - `ReportListView.tsx` - DataGrid with filters (similar to PayslipListView from Story 7.6)
  - `ReportPreviewDialog.tsx` - Detail modal (similar to PayslipPreviewDialog from Story 7.6)
  - `ReportGenerationPanel.tsx` - Admin generation interface (similar to PayslipGenerationPanel from Story 7.6)
  - `ComplianceStatusDashboard.tsx` - Status tracking and deadline alerts
  - `ScheduledReportsPanel.tsx` - Schedule management interface
  - `index.ts` - Component exports
- Types: `frontend/src/types/compliance/compliance.types.ts` (new)
- Service: `frontend/src/services/compliance/complianceService.ts` (new)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Product Manager John |
| 2024-12-29 | 1.1 | Clarified compliance reporting authorization roles | Scrum Master Bob |
| 2024-12-29 | 1.2 | Updated to reference payroll configuration from Story 7.1 | Product Owner Sarah |
| 2025-01-02 | 1.3 | Updated Story 7.2 dependency status to complete; Added explicit note about country-specific report filtering using component mapping from Story 7.2 | Product Owner Sarah |
| 2025-10-03 | 2.0 | **MAJOR UPDATE after Epic 7 review:** Added Story 7.3, 7.4, 7.5, 7.6 integration points; Added Story 7.6 as CRITICAL dependency (PayslipStorageService as primary data source); Clarified NO RE-CALCULATION rule (use stored payslip data); Added AuditService integration (Story 7.3); Added caching patterns (5-min TTL from Story 7.3); Updated Task 1-5 with integration points; Expanded Task 7 with Stories 7.4-7.6 frontend patterns (tab-based layout, DataGrid, components); Added comprehensive Integration Points section; Updated Business Rules with data source clarifications; Added Payslip entity to Data Models | Scrum Master Bob |
