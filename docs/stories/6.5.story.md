# Story 6.5 — HR Review Dashboard

## Status
Draft

## Story
**As an** HR manager,
**I want** a centralized dashboard to review candidate onboarding submissions with per-category document verification,
**so that** I can efficiently approve/reject documents, request changes, and maintain compliance before granting EOR role.

## Acceptance Criteria
1. **Centralized Dashboard:** View all candidates in `onboarding` status with submission progress indicators
2. **Per-Category Checklist:** Display document counts and verification status for each category (Profile, CVs, Identity, Employment, Education)
3. **Document Review:** View uploaded documents with metadata (filename, size, upload date, status)
4. **Verification Actions:** Approve/Reject/Request-Changes with mandatory comment field
5. **Status Transitions:** Mark documents as Verified (approved) or Needs Changes with HR notes
6. **Verified Lock:** Verified documents become non-deletable by candidate/EOR; display lock icon
7. **Bulk Actions:** Select multiple documents for batch verification (same action + comment)
8. **Full Audit Trail:** Log all verification actions (approve/reject/request-changes) with actor, timestamp, employmentRecordId, IP, userAgent
9. **Revocation (Admin Only):** HR admins can revoke verification status with reason and audit entry
10. **Filtering & Search:** Filter by candidate name, submission date, status; search documents
11. **Accessibility:** WCAG 2.1 AA compliant; keyboard navigable; screen reader friendly
12. **Design Consistency:** Match Material-UI 3 expressive design patterns from Stories 6.1-6.2

## Context from Stories 6.1-6.4

**Story 6.1** established:
- OnboardingWizardPage with 3 steps
- Employment records with `status='onboarding'`
- Audit logging infrastructure
- onboardingService patterns

**Story 6.2** established:
- Unified `/v1/documents` endpoint
- Document categories: cv, identity, employment, education
- Document statuses: pending, approved, needs_changes, rejected
- Documents table with `status`, `reviewed_by`, `reviewed_at`, `review_notes` columns
- documentsService and DocumentList/DocumentTabs components

**Stories 6.3-6.4**:
- Confirmed all document categories working via My Documents hub

**Story 6.5 builds the HR side** - enabling HR managers to review and verify all candidate submissions.

## Tasks / Subtasks

- [ ] Task 1: HR Dashboard Page (AC: 1, 2, 10, 12)
  - [ ] Create `HROnboardingDashboardPage.tsx` at `/hr/onboarding`
  - [ ] Fetch employment records with `status='onboarding'`
  - [ ] Display candidate list with profile data and submission progress
  - [ ] Show per-category document counts (0/1 CVs, 1/1 Identity, etc.)
  - [ ] Implement search and filter controls
  - [ ] Add route to App.tsx with RBAC (admin, hr roles only)

- [ ] Task 2: Document Review Modal (AC: 3, 4, 5)
  - [ ] Create `DocumentReviewModal.tsx` component
  - [ ] Display document preview/download link
  - [ ] Show document metadata (name, size, upload date, current status)
  - [ ] Add action buttons: Approve, Reject, Request Changes
  - [ ] Implement comment/notes textarea (required for all actions)
  - [ ] Validate comment is provided before submission

- [ ] Task 3: Backend Verification Endpoints (AC: 4, 5, 8)
  - [ ] Create `PATCH /api/v1/documents/:id/verify` endpoint
  - [ ] Accept body: `{ action: 'approve' | 'reject' | 'needs_changes', notes: string }`
  - [ ] Update document status, reviewed_by, reviewed_at, review_notes
  - [ ] Emit audit log with verification action and full context
  - [ ] Return updated document with new status
  - [ ] Add roles guard: `@Roles('admin', 'hr')`

- [ ] Task 4: Verified Lock Implementation (AC: 6)
  - [ ] Update DocumentService.deleteDocument to check `status='approved'`
  - [ ] Return 403 Forbidden if candidate/EOR tries to delete verified doc
  - [ ] Frontend: Disable delete button for approved documents
  - [ ] Display lock icon on verified documents in document lists
  - [ ] Show tooltip: "Verified documents cannot be deleted"

- [ ] Task 5: Bulk Verification Actions (AC: 7)
  - [ ] Add checkbox selection to document review list
  - [ ] Create `POST /api/v1/documents/bulk-verify` endpoint
  - [ ] Accept body: `{ documentIds: string[], action: string, notes: string }`
  - [ ] Process verification for all selected documents
  - [ ] Return summary: { success: number, failed: number, errors: any[] }
  - [ ] Emit audit log for each document verification
  - [ ] Frontend: Bulk action toolbar when documents selected

- [ ] Task 6: Verification Revocation (AC: 9)
  - [ ] Create `POST /api/v1/documents/:id/revoke-verification` endpoint
  - [ ] Accept body: `{ reason: string }` (required)
  - [ ] Check user has `admin` role (not just `hr`)
  - [ ] Update document status from `approved` → `pending`
  - [ ] Clear reviewed_by, reviewed_at, but preserve review_notes (history)
  - [ ] Emit audit log: action='revoke_verification' with reason
  - [ ] Frontend: "Revoke Verification" button (admin only, on verified docs)

- [ ] Task 7: Audit Logging Enhancement (AC: 8)
  - [ ] Extend AuditLog to capture verification events
  - [ ] Actions: 'verify_document', 'reject_document', 'request_changes', 'revoke_verification'
  - [ ] Include in changes: { documentId, fileName, category, action, notes, previousStatus, newStatus }
  - [ ] Capture IP and userAgent from request
  - [ ] Link to employmentRecordId for traceability

- [ ] Task 8: HR Dashboard Data Service (AC: 1, 2)
  - [ ] Create `hrOnboardingService.ts` frontend service
  - [ ] Method: `getOnboardingCandidates()` → list employment records with user data
  - [ ] Method: `getCandidateDocuments(userId)` → fetch all docs by category
  - [ ] Method: `verifyDocument(docId, action, notes)` → call verify endpoint
  - [ ] Method: `bulkVerifyDocuments(docIds, action, notes)` → call bulk endpoint
  - [ ] Method: `revokeVerification(docId, reason)` → call revoke endpoint (admin only)

- [ ] Task 9: UI Components (AC: 3, 4, 11, 12)
  - [ ] `CandidateCard.tsx` - Card showing candidate info + progress
  - [ ] `DocumentReviewList.tsx` - List of documents with status badges
  - [ ] `DocumentReviewModal.tsx` - Modal for single document review
  - [ ] `BulkActionToolbar.tsx` - Toolbar for bulk verification actions
  - [ ] `VerificationHistoryDialog.tsx` - Show audit trail for a document
  - [ ] Apply Material-UI 3 styling consistent with My Documents page

- [ ] Task 10: RBAC Enforcement (AC: 9)
  - [ ] Backend: Use `@Roles('admin', 'hr')` on all verification endpoints
  - [ ] Backend: Use `@Roles('admin')` on revoke-verification endpoint
  - [ ] Frontend: Hide/disable revoke button unless user has admin role
  - [ ] Frontend: Show error if non-HR user tries to access HR dashboard

- [ ] Task 11: Notification Triggers (Story 6.6 dependency)
  - [ ] Emit event when document verification status changes
  - [ ] Include: userId, documentId, action, notes, employmentRecordId
  - [ ] Story 6.6 will consume these events for notifications
  - [ ] For now, just emit events; no notification delivery yet

- [ ] Task 12: Testing (AC: 1-12)
  - [ ] Unit tests: hrOnboardingService methods
  - [ ] Unit tests: Document verification logic
  - [ ] Integration tests: Verification endpoints with audit logging
  - [ ] Integration tests: RBAC enforcement (admin vs hr vs candidate)
  - [ ] E2E tests: HR dashboard → review → verify → check candidate view
  - [ ] E2E tests: Bulk verification workflow
  - [ ] E2E tests: Admin revoke verification
  - [ ] Accessibility tests: Keyboard navigation, ARIA labels

- [ ] Task 13: Documentation
  - [ ] Create user guide: `docs/user-guides/hr-onboarding-review.md`
  - [ ] Document verification workflow and decision criteria
  - [ ] Add troubleshooting section for common review scenarios

## Dev Notes

### Previous Story Insights

From Stories 6.1-6.4:
- **Employment Records**: Use `status='onboarding'` to identify candidates
- **Document Schema**: Documents table has columns for verification: `status`, `reviewed_by`, `reviewed_at`, `review_notes`
- **Document Statuses**: Enum values in backend: `'pending' | 'approved' | 'rejected' | null`; `needs_changes` will need to be added to constraint
- **Audit Pattern**: Use `auditService.log()` with employmentRecordId, actor, action, changes
- **RBAC**: Existing roles: `admin`, `hr`, `candidate`, `eor`; use `@Roles` decorator on controllers
- **API Pattern**: RESTful endpoints at `/api/v1/{resource}`

### Data Models

**Document Entity (Extended for Review)** [Source: init-db.sql lines 778-808]
```sql
CREATE TABLE documents (
  -- ... existing columns ...
  status VARCHAR(20), -- 'pending', 'approved', 'rejected', or null
  reviewed_by UUID REFERENCES users(id),
  reviewed_at TIMESTAMP,
  review_notes TEXT,
  -- ... other columns ...
  CONSTRAINT chk_document_status CHECK (
    status IN ('pending', 'approved', 'rejected', 'needs_changes') OR status IS NULL
  )
);
```

**Note**: Need to add `'needs_changes'` to the status constraint in a migration.

**Employment Record Entity** [Source: init-db.sql]
```sql
CREATE TABLE employment_records (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id),
  client_id UUID NOT NULL REFERENCES clients(id),
  country_id UUID NOT NULL REFERENCES countries(id),
  status employment_status_enum NOT NULL, -- 'onboarding', 'active', etc.
  start_date DATE,
  end_date DATE,
  -- ... other columns ...
);
```

**Audit Log Entity** [Source: src/audit/entities/audit-log.entity.ts]
```typescript
@Entity('audit_logs')
export class AuditLog {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ name: 'actor_user_id', type: 'uuid', nullable: true })
  actorUserId: string;

  @Column({ name: 'actor_role', nullable: true })
  actorRole: string;

  @Column({ name: 'action' })
  action: string; // e.g., 'verify_document', 'reject_document'

  @Column({ name: 'entity_type' })
  entityType: string; // 'Document'

  @Column({ name: 'entity_id', nullable: true })
  entityId: string; // Document ID

  @Column({ name: 'changes', type: 'jsonb', nullable: true })
  changes: any; // { documentId, action, notes, previousStatus, newStatus }

  @Column({ name: 'ip_address', nullable: true })
  ipAddress: string;

  @Column({ name: 'user_agent', nullable: true })
  userAgent: string;

  @Column({ name: 'employment_record_id', type: 'uuid', nullable: true })
  employmentRecordId: string;

  @Column({ name: 'client_id', type: 'uuid', nullable: true })
  clientId: string;

  @Column({ name: 'created_at', type: 'timestamptz', default: () => 'CURRENT_TIMESTAMP' })
  createdAt: Date;
}
```

### API Specifications

**Verify Document Endpoint** [New]
- **Endpoint**: `PATCH /api/v1/documents/:id/verify`
- **Auth**: JWT required; roles: `admin`, `hr`
- **Path Params**: `id` (UUID) - Document ID
- **Request Body**:
  ```typescript
  {
    action: 'approve' | 'reject' | 'needs_changes', // Required
    notes: string // Required, min 10 chars
  }
  ```
- **Response** (200):
  ```typescript
  {
    id: string,
    status: 'approved' | 'rejected' | 'needs_changes',
    reviewedBy: string, // User ID
    reviewedAt: string, // ISO timestamp
    reviewNotes: string
  }
  ```
- **Validation**:
  - Document must exist and belong to a user
  - `notes` is required (use class-validator `@IsNotEmpty()`, `@MinLength(10)`)
  - `action` must be one of three valid values

**Bulk Verify Endpoint** [New]
- **Endpoint**: `POST /api/v1/documents/bulk-verify`
- **Auth**: JWT required; roles: `admin`, `hr`
- **Request Body**:
  ```typescript
  {
    documentIds: string[], // Array of document UUIDs
    action: 'approve' | 'reject' | 'needs_changes',
    notes: string // Same notes applied to all
  }
  ```
- **Response** (200):
  ```typescript
  {
    success: number, // Count of successfully verified docs
    failed: number, // Count of failed verifications
    errors: Array<{ documentId: string, error: string }> // Details of failures
  }
  ```

**Revoke Verification Endpoint** [New]
- **Endpoint**: `POST /api/v1/documents/:id/revoke-verification`
- **Auth**: JWT required; roles: `admin` (ONLY admin, not hr)
- **Path Params**: `id` (UUID) - Document ID
- **Request Body**:
  ```typescript
  {
    reason: string // Required, min 20 chars (more detailed than verification notes)
  }
  ```
- **Response** (200):
  ```typescript
  {
    id: string,
    status: 'pending', // Reverted to pending
    reviewedBy: null,
    reviewedAt: null,
    reviewNotes: string // Preserved for history
  }
  ```

**Get Onboarding Candidates Endpoint** [New or extend existing]
- **Endpoint**: `GET /api/v1/hr/onboarding-candidates`
- **Auth**: JWT required; roles: `admin`, `hr`
- **Query Params**:
  - `search?: string` - Search by name or email
  - `sortBy?: 'submittedAt' | 'name' | 'progress'`
  - `order?: 'asc' | 'desc'`
- **Response** (200):
  ```typescript
  {
    candidates: Array<{
      employmentRecordId: string,
      userId: string,
      userName: string,
      userEmail: string,
      submittedAt: string,
      documentProgress: {
        cv: { uploaded: number, verified: number, total: number },
        identity: { uploaded: number, verified: number, total: number },
        employment: { uploaded: number, verified: number, total: number },
        education: { uploaded: number, verified: number, total: number }
      }
    }>
  }
  ```

### Component Specifications

**HROnboardingDashboardPage** [New]
- **Location**: `frontend/src/pages/HROnboardingDashboardPage.tsx`
- **Route**: `/hr/onboarding`
- **State Management**:
  ```typescript
  const [candidates, setCandidates] = useState<OnboardingCandidate[]>([]);
  const [selectedCandidate, setSelectedCandidate] = useState<OnboardingCandidate | null>(null);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState<'all' | 'pending' | 'verified'>('all');
  ```
- **Key Features**:
  - Grid of candidate cards with submission progress
  - Click candidate card → open detailed review panel
  - Search bar and filter controls at top
  - Real-time updates when documents verified

**DocumentReviewModal** [New]
- **Location**: `frontend/src/components/hr/DocumentReviewModal.tsx`
- **Props**:
  ```typescript
  interface DocumentReviewModalProps {
    open: boolean;
    onClose: () => void;
    document: Document;
    onVerify: (action: string, notes: string) => Promise<void>;
  }
  ```
- **Features**:
  - Document preview or download link
  - Metadata display (filename, size, uploaded date, current status)
  - Action buttons: Approve (green), Reject (red), Request Changes (orange)
  - Text area for notes (required, with validation)
  - Submit button disabled until notes entered
  - Loading state during API call

**CandidateCard** [New]
- **Location**: `frontend/src/components/hr/CandidateCard.tsx`
- **Props**:
  ```typescript
  interface CandidateCardProps {
    candidate: OnboardingCandidate;
    onClick: (candidate: OnboardingCandidate) => void;
  }
  ```
- **Features**:
  - Display candidate name, email, submission date
  - Progress indicators for each document category
  - Overall completion percentage
  - Hover effect and click to open review panel
  - Material-UI Card with gradient border if complete

### File Locations

[Source: docs/architecture/source-tree.md and Story 6.1/6.2 patterns]

**Backend Files to Create**:
- `src/documents/controllers/document-verification.controller.ts` - Verification endpoints
- `src/documents/dto/verify-document.dto.ts` - Verify document DTO
- `src/documents/dto/bulk-verify.dto.ts` - Bulk verify DTO
- `src/documents/dto/revoke-verification.dto.ts` - Revoke verification DTO
- `src/employment-records/controllers/hr-onboarding.controller.ts` - Get onboarding candidates
- `src/employment-records/services/hr-onboarding.service.ts` - Business logic for HR operations

**Backend Files to Modify**:
- `src/documents/documents.module.ts` - Register new controller
- `src/employment-records/employment-records.module.ts` - Register HR controller
- `init-db.sql` - Update document status constraint to include 'needs_changes'

**Frontend Files to Create**:
- `frontend/src/pages/HROnboardingDashboardPage.tsx` - Main HR dashboard
- `frontend/src/services/hrOnboardingService.ts` - API service for HR operations
- `frontend/src/components/hr/CandidateCard.tsx` - Candidate info card
- `frontend/src/components/hr/DocumentReviewModal.tsx` - Document review modal
- `frontend/src/components/hr/DocumentReviewList.tsx` - List of documents for review
- `frontend/src/components/hr/BulkActionToolbar.tsx` - Bulk verification toolbar
- `frontend/src/components/hr/VerificationHistoryDialog.tsx` - Audit trail view
- `frontend/src/types/hrOnboarding.types.ts` - TypeScript type definitions

**Frontend Files to Modify**:
- `frontend/src/App.tsx` - Add `/hr/onboarding` route with RBAC
- `frontend/src/hooks/useRoleBasedNavigation.ts` - Add HR Onboarding nav item
- `frontend/src/components/SidebarMUI.tsx` - Add icon for HR Onboarding

**Database Migration Files to Create**:
- `migrations/add-needs-changes-document-status.sql` - Add 'needs_changes' to status constraint

### Technical Constraints

[Source: Epic 6, Story 6.2, coding-standards.md]

- **RBAC**: Verification endpoints require `@Roles('admin', 'hr')`; revocation requires `@Roles('admin')` only
- **Audit Logging**: All verification actions MUST emit audit logs with full context
- **Verified Lock**: Candidates/EORs cannot delete documents with `status='approved'`
- **Status Transition Rules**:
  - `pending` → `approved` | `rejected` | `needs_changes` (HR action)
  - `approved` → `pending` (Admin revoke only)
  - `needs_changes` → `approved` | `rejected` (HR re-review after candidate re-upload)
  - `rejected` → Cannot transition (terminal state; candidate must upload new version)
- **Comment Requirements**: Verification actions require minimum 10-char notes; revocation requires 20-char reason
- **Bulk Actions**: Must be atomic (all succeed or all fail); use database transactions
- **Frontend Validation**: Validate notes before API call to reduce failed requests

### Testing

[Source: docs/architecture/coding-standards.md, testing-strategy.md]

**Unit Tests**:

`backend/src/documents/services/document-verification.service.spec.ts`:
```typescript
describe('DocumentVerificationService', () => {
  it('should approve document and update status', () => { ... });
  it('should reject document with notes', () => { ... });
  it('should mark document as needs_changes', () => { ... });
  it('should emit audit log on verification', () => { ... });
  it('should throw error if notes missing', () => { ... });
  it('should throw error if document not found', () => { ... });
  it('should allow admin to revoke verification', () => { ... });
  it('should prevent non-admin from revoking', () => { ... });
  it('should preserve review_notes history on revoke', () => { ... });
});
```

`frontend/src/services/__tests__/hrOnboardingService.test.ts`:
```typescript
describe('hrOnboardingService', () => {
  it('should fetch onboarding candidates', () => { ... });
  it('should verify document with action and notes', () => { ... });
  it('should bulk verify multiple documents', () => { ... });
  it('should revoke verification with reason', () => { ... });
  it('should handle API errors gracefully', () => { ... });
});
```

**Integration Tests**:
- Verification endpoint with RBAC enforcement
- Bulk verification with partial failures
- Revocation endpoint (admin only)
- Audit log creation for all actions
- Status transition edge cases

**E2E Tests** (Playwright):
- HR logs in → navigates to HR Onboarding Dashboard
- Select candidate → view documents → verify one document
- Verify multiple documents with bulk action
- Admin revokes verification → candidate can re-upload
- Candidate uploads new version after "needs changes" → HR re-reviews
- Verified document shows lock icon → candidate cannot delete

**Accessibility Tests**:
- Keyboard navigation through candidate list and review modals
- Screen reader announcements for verification actions
- Color contrast for status badges (green, red, orange)
- Focus management when opening/closing modals

## Dependencies
- **Story 6.1** (Completed): Employment records with onboarding status
- **Story 6.2** (Completed): Document upload system with status fields
- Epic 6: EOR Onboarding Workflow
- Existing AuditModule for audit logging
- Story 6.6 (Remediation & Resubmission) will build on this for notifications

## Risks & Mitigation
- **Complex RBAC**: Admin vs HR permissions → Clear role checks in guards; comprehensive tests
- **Bulk Action Failures**: Partial success scenarios → Return detailed error array; use transactions
- **Audit Log Volume**: High verification activity → Index audit_logs table; consider retention policy
- **Status Confusion**: Multiple status values → Clear UI labels; help tooltips; user guide
- **Revocation Abuse**: Admins revoking without reason → Enforce reason field; audit all revocations

## Definition of Done
- All acceptance criteria met and verified
- All tasks completed with passing tests (unit, integration, E2E)
- RBAC enforced on all verification endpoints (admin/hr roles)
- Audit logs present for all verification and revocation actions
- Accessibility checks pass (WCAG 2.1 AA, keyboard navigation)
- Database migration applied (add 'needs_changes' status)
- User guide created: `docs/user-guides/hr-onboarding-review.md`
- Code reviewed and merged to main branch

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story draft for HR Review Dashboard based on Epic 6 Phase 2 | Scrum Master Bob |



