# Story 7.12: Bank Payment File Generation & Payment Tracking

## Status
Draft

## Story
**As a** HR manager and payroll administrator,
**I want** to generate bank payment files in standard formats (BACS, NACHA, India/Philippines local formats) and track payment status,
**so that** I can efficiently process employee salary payments through banking systems and maintain a complete audit trail of payment transactions.

## Acceptance Criteria
1. **Bank Account Management:** CRUD interface for managing employee bank account details with validation
2. **Bank File Format Configuration:** Support for multiple bank file formats (BACS, NACHA, India local formats, Philippines local formats)
3. **Bank File Generation:** Generate bank payment files from completed payroll runs with validation
4. **Payment File Preview:** Preview payment file contents before download/export
5. **Payment Status Tracking:** Track payment status lifecycle (Pending → File Generated → Sent to Bank → Confirmed → Failed)
6. **Payment Confirmation Upload:** Upload bank confirmation files and match to payments
7. **Payment Reconciliation:** Reconcile bank payments with payroll processing logs
8. **Audit Trail:** Complete tracking of all bank file generation, downloads, and payment status changes
9. **Payment Failure Handling:** Mark failed payments and support re-generation for failed employees
10. **API Integration:** RESTful API endpoints following existing v1 patterns
11. **UI Integration:** Material-UI interface integrated into Payroll Administration page (Story 7.8)
12. **Security:** Secure file generation with encryption options, role-based access control

## Dependencies
- **Story 7.1:** Multi-Region Foundation ✅ **COMPLETE** (provides Country, Currency entities)
- **Story 7.3:** Payroll Calculation Engine ✅ **COMPLETE** (provides payroll calculation data)
- **Story 7.6:** Employee Payroll Self-Service ✅ **COMPLETE** (provides Payslip entity as data source)
- **Story 7.8:** Advanced Payroll Administration & Monitoring ✅ **COMPLETE** (provides PayrollPeriod, PayrollProcessingLog)
- **Story 1.2:** User Management ✅ **COMPLETE** (provides User entity for bank account association)
- **Story 1.4:** Employment Records Management ✅ **COMPLETE** (provides employment record data)

## Tasks / Subtasks

- [ ] **Task 1: Create Bank Payment Module and Entities (AC: 1, 8)**
  - [ ] Create BankAccount entity (user, accountNumber, routingNumber, IBAN, SWIFT, bankName, branchCode, accountType, isActive, isPrimary)
  - [ ] Create PaymentBatch entity (payrollPeriodId, payrollProcessingLogId, countryId, batchNumber, fileFormat, totalAmount, totalEmployees, status, generatedAt, generatedBy)
  - [ ] Create PaymentRecord entity (paymentBatchId, userId, payslipId, accountNumber, amount, currency, status, referenceNumber, errorMessage)
  - [ ] Create PaymentFileConfiguration entity (countryId, fileFormat, templateConfig, headerConfig, footerConfig, validationRules, isActive)
  - [ ] Add indexes for performance (paymentBatchId, userId, payrollPeriodId, status)
  - [ ] Create migration files for new tables
  - [ ] Update init-db.sql with bank payment tables

- [ ] **Task 2: Implement Bank Account Management Service (AC: 1)**
  - [ ] Create BankAccountService with CRUD operations
  - [ ] Implement validation (account number format, routing number format, IBAN validation, SWIFT validation)
  - [ ] Add getPrimaryBankAccount(userId) method
  - [ ] Add setBankAccountAsPrimary(userId, accountId) method
  - [ ] Add validateBankAccountForCountry(countryCode, bankAccount) method
  - [ ] Integrate with AuditService for all bank account changes
  - [ ] Create BankAccountController with REST endpoints
  - [ ] Implement DTOs (CreateBankAccountDto, UpdateBankAccountDto, BankAccountResponseDto)

- [ ] **Task 3: Implement Bank File Format Configuration (AC: 2)**
  - [ ] Create PaymentFileConfigurationService
  - [ ] Implement BACS format configuration (UK standard - 18-byte header, variable records)
  - [ ] Implement NACHA format configuration (US ACH - 94-byte fixed records with batch control)
  - [ ] Implement India NEFT/RTGS format (Excel/CSV with specific column headers)
  - [ ] Implement Philippines ACH format (local banking standard)
  - [ ] Create format templates with configurable fields (company ID, batch ID, effective date, etc.)
  - [ ] Add format validation rules per country
  - [ ] Create PaymentFileConfigurationController
  - [ ] Implement configuration DTOs

- [ ] **Task 4: Implement Bank File Generation Service (AC: 3, 4, 9)**
  - [ ] Create BankFileGenerationService
  - [ ] Implement generatePaymentFile(periodId, fileFormat, options) method
  - [ ] Fetch completed payslips from PayslipStorageService (Story 7.6)
  - [ ] Fetch employee bank accounts from BankAccountService
  - [ ] Validate all employees have valid bank accounts
  - [ ] Create PaymentBatch record with status DRAFT
  - [ ] Generate file content based on selected format (BACS/NACHA/India/Philippines)
  - [ ] Create PaymentRecord for each employee
  - [ ] Validate file content against format rules
  - [ ] Calculate batch totals and control records
  - [ ] Return file content as buffer/stream for download
  - [ ] Update PaymentBatch status to FILE_GENERATED on success
  - [ ] Support regeneration for failed payment records only
  - [ ] Integrate with PerformanceMetricsService to track generation time

- [ ] **Task 5: Implement Payment Status Tracking (AC: 5, 6, 7)**
  - [ ] Create PaymentTrackingService
  - [ ] Implement updatePaymentBatchStatus(batchId, status, metadata) method
  - [ ] Implement updatePaymentRecordStatus(recordId, status, referenceNumber, errorMessage) method
  - [ ] Create uploadBankConfirmation(batchId, confirmationFile) method
  - [ ] Parse bank confirmation file and extract payment statuses
  - [ ] Match confirmation records to PaymentRecord entries
  - [ ] Update payment statuses (Confirmed/Failed) based on bank response
  - [ ] Send notifications for failed payments
  - [ ] Create reconciliation report comparing expected vs. actual payments
  - [ ] Integrate with AuditService for all status changes

- [ ] **Task 6: Create Bank Payment REST API (AC: 10)**
  - [ ] Create PaymentBatchController with endpoints:
    - [ ] POST /api/v1/payroll/payments/generate - Generate payment file
    - [ ] GET /api/v1/payroll/payments/batches - List payment batches
    - [ ] GET /api/v1/payroll/payments/batches/:id - Get batch details
    - [ ] GET /api/v1/payroll/payments/batches/:id/download - Download payment file
    - [ ] GET /api/v1/payroll/payments/batches/:id/preview - Preview payment records
    - [ ] POST /api/v1/payroll/payments/batches/:id/confirm - Upload bank confirmation
    - [ ] PUT /api/v1/payroll/payments/batches/:id/status - Update batch status
    - [ ] POST /api/v1/payroll/payments/batches/:id/regenerate-failed - Regenerate failed payments
    - [ ] GET /api/v1/payroll/payments/reconciliation/:periodId - Get reconciliation report
  - [ ] Add role-based authorization (admin, hr roles only)
  - [ ] Add Swagger/OpenAPI documentation
  - [ ] Implement proper error handling and validation

- [ ] **Task 7: Create Bank Payment Frontend UI (AC: 11)**
  - [ ] Add "Bank Payments" tab to PayrollAdministrationPage (Story 7.8)
  - [ ] Create BankPaymentsTab.tsx component with Material-UI design
  - [ ] **Section 1: Generate Payment File**
    - [ ] Period selector dropdown (only COMPLETED periods)
    - [ ] File format selector (BACS, NACHA, India NEFT, Philippines ACH)
    - [ ] Preview button to show payment records before generation
    - [ ] Generate button to create file
    - [ ] Download button for generated file
  - [ ] **Section 2: Payment Batches DataGrid**
    - [ ] Columns: Batch Number, Period, Country, Format, Total Amount, Employees, Status, Generated Date, Actions
    - [ ] Status chips with color coding (DRAFT, FILE_GENERATED, SENT_TO_BANK, CONFIRMED, FAILED)
    - [ ] Actions: Download File, Upload Confirmation, View Details, Regenerate Failed
  - [ ] **Section 3: Payment Batch Details Dialog**
    - [ ] Batch summary (totals, status, generated by, timestamp)
    - [ ] Payment records DataGrid (employee, account, amount, status, reference)
    - [ ] Filter by payment status (All, Confirmed, Failed)
    - [ ] Export individual employee payment records
  - [ ] Create PaymentPreviewDialog.tsx for previewing payments before generation
  - [ ] Create BankConfirmationUploadDialog.tsx for uploading bank confirmation files
  - [ ] Add loading states, error handling, and success notifications

- [ ] **Task 8: Implement Employee Bank Account Management UI (AC: 1)**
  - [ ] Add "Bank Details" section to ProfilePage (Story 2.6)
  - [ ] Create BankAccountManagement.tsx component
  - [ ] Display primary bank account with edit/delete options
  - [ ] Add "Add Bank Account" button and dialog
  - [ ] Form fields: Account Number, Routing/Sort Code, IBAN (optional), SWIFT (optional), Bank Name, Branch, Account Type
  - [ ] Client-side validation for account formats per country
  - [ ] Mark account as primary option
  - [ ] Display list of all bank accounts with primary indicator
  - [ ] Admin/HR can manage employee bank accounts via User Management page

- [ ] **Task 9: Implement Security and Encryption (AC: 12)**
  - [ ] Add file encryption option for sensitive payment files
  - [ ] Implement PGP encryption support (optional configuration)
  - [ ] Add password protection for generated files (optional)
  - [ ] Implement secure file download with expiring tokens
  - [ ] Add IP whitelist for payment file downloads (optional)
  - [ ] Audit all file downloads with timestamp, user, IP address
  - [ ] Implement rate limiting for payment file generation
  - [ ] Add role-based permissions (only admin/hr can generate files)

- [ ] **Task 10: Testing and Validation (AC: All)**
  - [ ] Create unit tests for BankFileGenerationService (all formats)
  - [ ] Create integration tests for payment workflow (generation → confirmation → reconciliation)
  - [ ] Test BACS format validation with sample files
  - [ ] Test NACHA format validation with sample files
  - [ ] Test India NEFT format with sample payroll data
  - [ ] Test Philippines ACH format with sample payroll data
  - [ ] Create E2E Playwright tests for frontend workflow
  - [ ] Test payment failure scenario and regeneration
  - [ ] Test bank confirmation upload and status matching
  - [ ] Validate audit trail completeness

- [ ] **Task 11: Update Database Seed Script (AC: All)**
  - [ ] Add sample bank accounts for seed users
  - [ ] Add sample payment file configurations for India and Philippines
  - [ ] Add sample payment batches for testing
  - [ ] Add sample payment records with various statuses
  - [ ] Include realistic bank confirmation data

- [ ] **Task 12: Documentation (AC: All)**
  - [ ] Document bank file format specifications for each country
  - [ ] Create admin guide for generating payment files
  - [ ] Document payment reconciliation process
  - [ ] Create troubleshooting guide for failed payments
  - [ ] Document bank account validation rules per country
  - [ ] Add API documentation for all payment endpoints

## Dev Notes

### Integration Points with Previous Stories

#### Story 7.6 (Employee Payroll Self-Service) - PRIMARY DATA SOURCE
- **PayslipStorageService:** Query completed payslips to generate payment records
- **Payslip Entity:** Source of employee payment amounts (netPay field)
- **Data Flow:** Payslip.netPay → PaymentRecord.amount

#### Story 7.8 (Payroll Administration) - ORCHESTRATION INTEGRATION
- **PayrollPeriod Entity:** Payment files generated per completed period
- **PayrollProcessingLog Entity:** Link payment batches to processing logs
- **UI Integration:** Add "Bank Payments" as 5th tab in PayrollAdministrationPage
- **Period Closure Workflow:** Period must be COMPLETED before payment file generation

#### Story 7.1 (Multi-Region Foundation)
- **Country Entity:** Payment file formats vary by country
- **Currency Entity:** Payment amounts in correct currency
- **CountryService:** Validate bank account formats per country

#### Story 7.3 (Payroll Calculation Engine)
- **AuditService:** Audit all payment file generation and status changes
- **Performance Monitoring:** Track payment file generation time

### Bank File Format Specifications

#### BACS (UK - Bankers' Automated Clearing Services)
- **File Structure:** Header (18 bytes) → Payment Records (Variable) → EOF
- **Header Fields:** File Creation Date, File Submission Number, Service User Number
- **Payment Record:** Destination Sort Code (6 digits), Account Number (8 digits), Amount (11 digits), Reference (18 chars)
- **Validation:** MOD-11 check digit validation for sort code

#### NACHA (US - Automated Clearing House)
- **File Structure:** File Header (94 bytes) → Batch Header → Payment Records → Batch Control → File Control
- **Fixed Record Length:** 94 bytes per line
- **Record Types:** 1 (File Header), 5 (Batch Header), 6 (Entry Detail), 8 (Batch Control), 9 (File Control)
- **Payment Record:** Routing Number (9 digits), Account Number (17 chars), Amount (10 digits)
- **Validation:** Routing number checksum, batch hash totals

#### India NEFT/RTGS
- **File Format:** Excel (.xlsx) or CSV
- **Column Headers:** Beneficiary Name, Account Number, IFSC Code, Amount, Payment Mode (NEFT/RTGS), Narration
- **IFSC Code:** 11 characters (Bank Code + Branch Code)
- **Validation:** IFSC code format, minimum amount for RTGS (₹2,00,000)

#### Philippines ACH
- **File Format:** CSV with specific column order
- **Column Headers:** Account Number, Account Name, Amount, Bank Code, Branch Code
- **Bank Code:** 4 digits (BSP assigned bank identifier)
- **Validation:** Bank code must exist in BSP registry

### Security Considerations
- **Sensitive Data:** Payment files contain account numbers, amounts, employee details
- **Access Control:** Only admin and hr roles can generate/download payment files
- **Audit Trail:** Log every file generation with user, timestamp, IP address, file hash
- **Encryption:** Optional PGP encryption for highly sensitive environments
- **File Expiry:** Generated files should have expiration period (configurable, default 7 days)
- **Download Tracking:** Track every file download with timestamp and user

### Business Rules
1. **Payment File Generation:**
   - Only COMPLETED payroll periods can generate payment files
   - All employees in period must have valid bank accounts
   - If any employee missing bank account, show warning and allow exclusion
   - Payment batch remains in DRAFT until admin confirms and downloads

2. **Payment Status Lifecycle:**
   - DRAFT → FILE_GENERATED (on successful generation)
   - FILE_GENERATED → SENT_TO_BANK (admin manually marks when sent)
   - SENT_TO_BANK → CONFIRMED (on successful bank confirmation upload)
   - SENT_TO_BANK → FAILED (if bank reports failure)
   - FAILED → FILE_GENERATED (on regeneration for failed payments)

3. **Payment Reconciliation:**
   - Match bank confirmation records to PaymentRecord by reference number or account number
   - Flag unmatched records as UNRECONCILED
   - Generate reconciliation report showing matched vs. unmatched
   - Admin must manually resolve UNRECONCILED records

4. **Failed Payments:**
   - Mark PaymentRecord as FAILED with error message from bank
   - Allow regeneration of payment file for failed records only
   - New payment batch created for failed payments with incremented batch number
   - Original batch remains as PARTIAL_SUCCESS status

5. **Bank Account Validation:**
   - UK: Validate sort code (6 digits) and account number (8 digits)
   - US: Validate routing number (9 digits with checksum) and account number
   - India: Validate IFSC code (11 characters, format: XXXX0YYYYYY)
   - Philippines: Validate bank code (4 digits from BSP registry)
   - Each country can have multiple account number formats

### Data Models

**New Entities:**
```typescript
BankAccount {
  id: UUID (PK)
  userId: UUID (FK → users.id)
  accountNumber: string
  routingNumber: string (optional - US)
  sortCode: string (optional - UK)
  ifscCode: string (optional - India)
  bankCode: string (optional - Philippines)
  iban: string (optional)
  swift: string (optional)
  bankName: string
  branchCode: string
  branchName: string
  accountType: enum (SAVINGS, CHECKING, CURRENT)
  accountHolderName: string
  isActive: boolean
  isPrimary: boolean
  createdAt: timestamp
  updatedAt: timestamp
}

PaymentBatch {
  id: UUID (PK)
  batchNumber: string (unique per country)
  payrollPeriodId: UUID (FK → payroll_periods.id)
  payrollProcessingLogId: UUID (FK → payroll_processing_logs.id)
  countryId: UUID (FK → countries.id)
  fileFormat: enum (BACS, NACHA, INDIA_NEFT, PHILIPPINES_ACH)
  totalAmount: decimal
  currency: string
  totalEmployees: integer
  confirmedEmployees: integer
  failedEmployees: integer
  status: enum (DRAFT, FILE_GENERATED, SENT_TO_BANK, CONFIRMED, PARTIAL_SUCCESS, FAILED)
  fileHash: string (SHA-256)
  generatedAt: timestamp
  generatedBy: UUID (FK → users.id)
  sentAt: timestamp
  confirmedAt: timestamp
  metadata: jsonb
}

PaymentRecord {
  id: UUID (PK)
  paymentBatchId: UUID (FK → payment_batches.id)
  userId: UUID (FK → users.id)
  payslipId: UUID (FK → payslips.id)
  bankAccountId: UUID (FK → bank_accounts.id)
  accountNumber: string (denormalized for audit)
  amount: decimal
  currency: string
  status: enum (PENDING, CONFIRMED, FAILED, UNRECONCILED)
  referenceNumber: string (bank transaction reference)
  errorMessage: string (if failed)
  confirmedAt: timestamp
  metadata: jsonb
}

PaymentFileConfiguration {
  id: UUID (PK)
  countryId: UUID (FK → countries.id)
  fileFormat: enum (BACS, NACHA, INDIA_NEFT, PHILIPPINES_ACH)
  formatName: string
  templateConfig: jsonb (format-specific settings)
  headerConfig: jsonb (company details, batch ID)
  footerConfig: jsonb (control totals)
  validationRules: jsonb (format validation rules)
  isActive: boolean
  createdAt: timestamp
  updatedAt: timestamp
}
```

### File Locations

**Backend:**
- Bank account service: `src/payroll/services/bank-account.service.ts`
- Bank file generation: `src/payroll/services/bank-file-generation.service.ts`
- Payment tracking: `src/payroll/services/payment-tracking.service.ts`
- Payment file configuration: `src/payroll/services/payment-file-configuration.service.ts`
- Format generators:
  - `src/payroll/services/bank-file-formats/bacs-generator.service.ts`
  - `src/payroll/services/bank-file-formats/nacha-generator.service.ts`
  - `src/payroll/services/bank-file-formats/india-neft-generator.service.ts`
  - `src/payroll/services/bank-file-formats/philippines-ach-generator.service.ts`
- Controllers:
  - `src/payroll/controllers/bank-account.controller.ts`
  - `src/payroll/controllers/payment-batch.controller.ts`
- Entities:
  - `src/payroll/entities/bank-account.entity.ts`
  - `src/payroll/entities/payment-batch.entity.ts`
  - `src/payroll/entities/payment-record.entity.ts`
  - `src/payroll/entities/payment-file-configuration.entity.ts`
- DTOs:
  - `src/payroll/dto/bank-account.dto.ts`
  - `src/payroll/dto/payment-batch.dto.ts`
  - `src/payroll/dto/payment-record.dto.ts`

**Frontend:**
- Bank payments tab: `frontend/src/components/payroll-admin/BankPaymentsTab.tsx`
- Payment preview dialog: `frontend/src/components/payroll-admin/PaymentPreviewDialog.tsx`
- Bank confirmation upload: `frontend/src/components/payroll-admin/BankConfirmationUploadDialog.tsx`
- Payment batch detail: `frontend/src/components/payroll-admin/PaymentBatchDetailDialog.tsx`
- Bank account management: `frontend/src/components/profile/BankAccountManagement.tsx`
- Types: `frontend/src/types/payroll-admin/bankPayment.types.ts`
- Service: `frontend/src/services/payroll-admin/bankPaymentService.ts`

### Testing

**Unit Tests:**
- `src/payroll/services/bank-file-generation.service.spec.ts`
- `src/payroll/services/bank-file-formats/bacs-generator.service.spec.ts`
- `src/payroll/services/bank-file-formats/nacha-generator.service.spec.ts`
- `frontend/src/components/payroll-admin/__tests__/BankPaymentsTab.test.tsx`

**Integration Tests:**
- `tests/integration/payment-workflow.test.ts` (generation → confirmation → reconciliation)
- `tests/integration/bank-file-formats.test.ts` (validate all format outputs)

**E2E Tests:**
- `tests/bank-payments-workflow.test.js` (Playwright)
  - Test payment file generation for completed period
  - Test payment batch listing and status display
  - Test bank confirmation upload
  - Test failed payment regeneration

**Test Data:**
- Sample BACS files for UK
- Sample NACHA files for US
- Sample India NEFT Excel files
- Sample Philippines ACH CSV files
- Sample bank confirmation files with matched/unmatched records

## API Specifications

### Bank Account Management
- **POST /api/v1/users/:userId/bank-accounts** - Create bank account
- **GET /api/v1/users/:userId/bank-accounts** - List user's bank accounts
- **GET /api/v1/users/:userId/bank-accounts/primary** - Get primary bank account
- **PUT /api/v1/users/:userId/bank-accounts/:id** - Update bank account
- **DELETE /api/v1/users/:userId/bank-accounts/:id** - Delete bank account
- **PUT /api/v1/users/:userId/bank-accounts/:id/set-primary** - Set as primary

### Payment Batch Management
- **POST /api/v1/payroll/payments/generate** - Generate payment file
- **GET /api/v1/payroll/payments/batches** - List payment batches (filter by country, period, status)
- **GET /api/v1/payroll/payments/batches/:id** - Get batch details with payment records
- **GET /api/v1/payroll/payments/batches/:id/download** - Download payment file
- **GET /api/v1/payroll/payments/batches/:id/preview** - Preview payment records before generation
- **POST /api/v1/payroll/payments/batches/:id/confirm** - Upload bank confirmation file
- **PUT /api/v1/payroll/payments/batches/:id/status** - Update batch status (manual)
- **POST /api/v1/payroll/payments/batches/:id/regenerate-failed** - Regenerate payment file for failed records
- **GET /api/v1/payroll/payments/reconciliation/:periodId** - Get reconciliation report

### Payment File Configuration
- **GET /api/v1/payroll/payments/configurations** - List file configurations by country
- **POST /api/v1/payroll/payments/configurations** - Create file configuration
- **PUT /api/v1/payroll/payments/configurations/:id** - Update configuration
- **DELETE /api/v1/payroll/payments/configurations/:id** - Deactivate configuration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-04 | 1.0 | Initial story creation - Bank Payment Integration | Product Owner Sarah |

