var CasesFilesCommon={appInfo:{},CURR_UPLOADED_FILES:[],getFileBoxProgressOnSelect:function(e,i,a,t){var l=$('<div name="fBox" filePos="'+i+'"></div>'),n=e.name.substring(e.name.lastIndexOf(".")+1),o=FilesCommon.getFileIcon(n),s=null!=e.size?FilesCommon.getFileSize(e.size):"",r=e.name;"workDriveUpload"==e.type&&(o="workdrive");var d=t?'<div class="zpl_atlct"></div>':"",c='<div class="zpl_atchimg"><i class="'+o+'"></i></div><div class="zpl_atchdtl"><h4>'+ZSEC.Encoder.encodeForHTML(r)+"</h4><p><span>"+s+"</span></p></div>"+d+'<div class="zpl_atchicn"><i title = "'+ZPI18N.getString("zp.delete")+'" onclick="CasesFilesCommon.removeFileDiv(this,'+t+')" class="PI_delete"></i></div><div class="zpl_prgbr"><div><div style="width:90%"></div></div></div>';l.html(c),null!=a&&"function"==typeof a&&a(l,e)},removeFileDiv:function(e,i){var a=$(e).closest("div[name=fBox]"),t=a.attr("fileid");i&&a.siblings("div[name=fBox]").length<=0&&casesSettings.CategoryModal.getReferencesParentDiv().find("div[id=refLstDiv]").append(CasesFAQ.emptyData(ZPI18N.getString("zp.noreferenceshead"),ZPI18N.getString("zp.referencesdesc"))),ZPUtil.Validation.isEmpty(t)?a.remove():a.addClass("zpl_DNI")},getFileBoxOnUpload:function(e){var i=$("#afilesAttach");$("#cgyfileUpd").trigger("click"),$("#cgyfileUpd").off("change").on("change",(function(e){$(this);var a=$(this)[0].files;$.each(a,(function(e){CasesFilesCommon.getFileBoxProgressOnSelect(a[e],e,(function(t,l){$(i).append(t),CasesFilesCommon.uploadFileByXHR(a[e],{fieldName:"attachment",formTable:"P_HRCase_FAQ",callback:function(i){$("#afilesAttach").find("div[filePos="+e+"]").replaceWith(CasesFilesCommon.setFileBoxAndDataOnSelect(i))},failureCallback:function(i){$("#afilesAttach").find("div[filepos="+e+"]").remove()}})}))}))}))},getFileBoxAfterUpload:function(e,i){var a=!(!e.hasOwnProperty("uploadSource")||"1"!=e.uploadSource),t=e.hasOwnProperty("extension")?e.extension:e.fileName.substring(e.fileName.lastIndexOf(".")+1),l=a?FilesCommon.getFileIcon("workdrive"):FilesCommon.getFileIcon(t),n=a&&""!=e.filePath?e.filePath:null!=e.fileSize?FilesCommon.getFileSize(e.fileSize):"",o=e.fileName,s='<div class="zpl_atchimg"><i class="'+l+'"></i></div><div class="zpl_atchdtl"><h4>'+ZSEC.Encoder.encodeForHTML(o)+"</h4><p><span>"+n+'</span></p></div><div class="zpl_atchicn"><i onclick="CasesFilesCommon.removeFileDiv(this)" title = "'+ZPI18N.getString("zp.delete")+'" class="PI_delete"></i></div>';return null!=i&&(s='<div name="fBox" fileid="'+i+'">'+s+"</div>"),s},setFileBoxAndDataOnSelect:function(e){var i=CasesFilesCommon.getFileBoxAfterUpload(e),a=$('<div name="fBox" filepath="'+e.fileId+'"></div>');return a.html(i),a.data("uploadMode","localUpload").data("caseFileUpload",JSON.stringify({filePath:e.fileId,fileName:e.fileName,fileSize:e.fileSize})),a},viewFileBox:function(e){var i=CasesFilesCommon.getFileBoxAfterUpload(e),a=$('<div name="fBox" fileid="'+e.fileUploadId+'"></div>');return a.html(i),a},getCloudPicker:function(e,i){var a=settingsPage.container.attr("id");CloudPicker.init(a,(function(){"AddCgyRef"==i?casesSettings.CategoryModal.referenceFileRowHtml(CloudPicker.getFileObj(),"cloudUpload"):"AddFAQ"==i&&CasesFilesCommon.setFileBoxAndTag("cloudUpload",CloudPicker.getFileObj(),"attachment")}),i),CloudPicker.construct()},setFileBoxAndTag:function(e,i,a){var t=$('<div name="fBox"></div>'),l={type:e};if("cloudUpload"==e){var n=JSON.parse(i);l.fileName=decodeURI(n.docName),l.extension=l.fileName.substring(l.fileName.lastIndexOf(".")+1)}else"workDriveUpload"==e?(l.extension="workdrive",l.fileName=i.fileName):l.fileName=i.filename;var o=CasesFilesCommon.getFileBoxAfterUpload(l);(t.html(o),t.data("uploadMode",e),"workDriveUpload"==e)?(i.labelName=a,t.data("WDUploadDoc",i)):((n=JSON.parse(i)).labelName=a,i=JSON.stringify(n),t.data("cloudUploadDoc",i));$("#afilesAttach").append(t)},uploadFileByXHR:function(e,i){var a=(new Date).getTime()+"_"+_LOGGEDIN_ZUID;Layout.ISLOCALIDCSETUP&&(UDS_UPLOAD_SERVICE_CODE=window.location.host.split(".")[0]);var t=UPLOAD_URL+"/"+UDS_UPLOAD_SERVICE_CODE+"/ver1/stream/upload";xhr=new XMLHttpRequest,xhr.instanceKey=xhr.upload.instanceKey=this.instanceKey,xhr.uploadId=xhr.upload.uploadId=a,this.appInfo.portalId=_LOGGEDIN_ACCZSOID,this.appInfo.moduleName="HRCase",this.appInfo.fieldName=i.fieldName,this.appInfo.formTableName=i.formTable,xhr.open("post",t,!0),xhr.setRequestHeader("x-assured-response",!0),xhr.setRequestHeader("x-streammode","1"),xhr.setRequestHeader("app-info",JSON.stringify(this.appInfo)),xhr.setRequestHeader("file-info",JSON.stringify({fileName:encodeURIComponent(e.name),contentType:e.type,fileSize:e.size})),xhr.setRequestHeader("upload-id",a),xhr.withCredentials=!0,xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.response);casesFiles.uploadCallBack(e,i)}else if(4==this.readyState&&200!=this.status){var a=JSON.parse(this.getResponseHeader("X-Error"));ZPeople.Message.showFailureMsg(a.errorMessage),null!=i.failureCallback&&"function"==typeof i.failureCallback&&i.failureCallback(a)}},xhr.send(e)},uploadCallBack:function(e,i){if(this.uploadedFileInfo=e,e.fileInfo){var a=e.fileInfo;null!=i.callback&&"function"==typeof i.callback&&i.callback(a)}else"Failure"==e.status&&(ZPeople.Message.showFailureMsg(e.message),null!=i.failureCallback&&"function"==typeof i.failureCallback&&i.failureCallback(e))},getAttachments:function(e,i){var a="";return $.each(i,(function(i,t){var l=t.fileName.substring(t.fileName.lastIndexOf(".")+1),n=t.hasOwnProperty("previewFileId")?t.previewFileId:"",o=t.fileName.substring(t.fileName.lastIndexOf(".")+1),s=FilesCommon.getFileIcon(o);"1"==t.uploadSource||t.filePath.indexOf(workDriveUrl)>-1||t.filePath.indexOf(writerUrl)>-1||t.filePath.indexOf(sheetUrl)>-1||t.filePath.indexOf(showUrl)>-1?(s="IC-wd",a+='<div class="attachedFile filePosts"  attachcnt="'+i+'1" onclick=window.open("'+t.filePath+'") > <i class="'+s+' fileType"></i><i onclick=window.open("'+t.filePath+'") class="IC-down"></i><div class="fileNameAndSize" ><label class="fileName" purpose="fileName">'+ZSEC.Encoder.encodeForHTML(t.fileName)+'</label> <span purpose="fileSize">'+(null!=t.filesize?t.filesize:"")+"</span> </div></div>"):a+='<div class="attachedFile filePosts"  attachcnt="'+i+'1" onclick="CasesFilesCommon.getLightBoxPreview(\''+t.fileUploadId+"','"+e+"','"+HR_CASE_ATTACHEMENTS+"','"+ZSEC.Encoder.encodeForHTML(ZSEC.Encoder.encodeForHTML(t.fileName))+"','"+ZSEC.Encoder.encodeForHTML(ZSEC.Encoder.encodeForHTML(l))+"','"+n+'\')"> <i class="'+s+' fileType"></i><i onclick="casesFilesCommon.getFileDownload(event,\''+t.fileUploadId+"','"+e+"','"+HR_CASE_ATTACHEMENTS+"',"+t.hasOwnProperty("previewFileId")+')" class="IC-down"></i><div class="fileNameAndSize" ><label class="fileName" purpose="fileName">'+ZSEC.Encoder.encodeForHTML(t.fileName)+'</label> <span purpose="fileSize">'+(null!=t.filesize?t.filesize:"")+"</span> </div></div>"})),a},getLightBoxPreview:function(e,i,a,t,l,n){var o="cases/category/files",s={fileId:e,recordId:i,fileType:a,conreqcsr:csrfToken,methodName:"viewCgyFile"};if(window.location.hash.includes("settings/service")){o="services/references/files",d=(d=window.location.hash.split("/")[2]).startsWith("#")?d.substring(1):d;var r=$.grep(ZPServices.SERVICE_JSON,(function(e){return e.tabName.toLowerCase()==d.toLowerCase()}));s.serviceName=r[0].tabName}else if(window.location.hash.includes("resources")){var d;o="services/references/files",d=(d=window.location.hash.split("/")[0]).startsWith("#")?d.substring(1):d;r=$.grep(ZPServices.SERVICE_JSON,(function(e){return e.tabName.toLowerCase()==d.toLowerCase()}));s.serviceName=r[0].tabName}var c=["jpg","jpeg","gif","png"],f=["xls","xlsx","sxc","ods","csv","tsv","doc","docx","sxw","odt","rtf","ppt","pptx","pps","odp","sxi"];if(n=null!=n?n:"",-1==f.indexOf(l)&&-1==c.indexOf(l)&&-1==["txt","sql","xml"].indexOf(l)&&"pdf"!=l)CasesFilesCommon.getFileDownload(event,e,i,a,""!=n,s);else{var p=-1!=c.indexOf(l),m=new LightBox(t);m.isImage=p,m.needPrint=!1,m.needDownload=!0,m.setDownloadCallback((function(){CasesFilesCommon.getFileDownload(event,e,i,a,""!=n,s)}));var u="";if(""!=n&&"pdf"==l)u="/pdfViewer.zp?fPath="+n+"&mode=HRCase&fileId="+e+"&recordId="+i+"&fType="+a,ZPUtil.Validation.isEmpty(s.serviceName)||(u+="&serviceName ="+s.serviceName),null!=contextPath&&"null"!=contextPath&&(u="/"+contextPath+u),m.viewUrl=u,m.show();else if(-1!=f.indexOf(l))$.ajax({url:o,type:"POST",data:s,async:!1,success:function(e,i,a){var t=e.url;t.startsWith("https:")||"undefined"==contextPath||"null"==contextPath||t.startsWith("/"+contextPath)||(t="/"+contextPath+t),m.viewUrl=t,m.show()}});else{var v=new XMLHttpRequest,h=new FormData;h.append("fileId",e),h.append("recordId",i),h.append("fileType",a),ZPUtil.Validation.isEmpty(s.serviceName)||h.append("serviceName",s.serviceName),h.append("methodName","viewCgyFile"),h.append("conreqcsr",csrfToken),v.open("post",o),v.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=URL.createObjectURL(this.response);u="/"+contextPath+u,m.viewUrl=e,m.show()}},v.responseType="blob",v.send(h)}}},getFileDownload:function(e,i,a,t,l,n){let o=window.location.hash.includes("settings/service")||window.location.hash.includes("resources")?"services/references/download":"cases/files/download";e.stopPropagation(),e.preventDefault(),Layout.Page.container.find("#dwlcgyFile").remove(),Layout.Page.container.find("#cgyDFileFrame").remove(),Layout.Page.container.append(`<form method="post" id="dwlcgyFile" enctype="multipart/form-data" action=${o} target="cgyDFileFrame" novalidate></form>`),Layout.Page.container.append('<iframe  src="" id="cgyDFileFrame" name="cgyDFileFrame" scrolling="auto" style="border: none; margin: 0pt;" frameborder="0" height="10px" width="100%" ></iframe>');var s=Layout.Page.container.find("#dwlcgyFile");s.append('<input type="hidden" name="fileId" value="'+i+'">'),s.append('<input type="hidden" name="recordId" value="'+a+'">'),s.append('<input type="hidden" name="fileType" value="'+t+'">'),s.append('<input type="hidden" name="conreqcsr" value="'+csrfToken+'">'),s.append('<input type="hidden" name="methodName" value="downloadFile">'),ZPUtil.Validation.isEmpty(n.serviceName)||s.append('<input type="hidden" name="serviceName" value="'+n.serviceName+'">'),s.trigger("submit"),$(s).find("input[type=hidden]").remove()}};